(function(_,G){typeof exports=="object"&&typeof module<"u"?G(exports):typeof define=="function"&&define.amd?define(["exports"],G):(_=typeof globalThis<"u"?globalThis:_||self,G(_.SakuraCraft={}))})(this,function(_){"use strict";var Vt=Object.defineProperty;var te=(_,G,rt)=>G in _?Vt(_,G,{enumerable:!0,configurable:!0,writable:!0,value:rt}):_[G]=rt;var Ct=(_,G,rt)=>te(_,typeof G!="symbol"?G+"":G,rt);const G=`
<!-- SakuraCraft Game HTML Template -->
<!-- This file is inserted into the DOM when the game initializes -->

<div class="minecraft-overlay" id="minecraftGame">
  <div class="minecraft-title">üå∏ SakuraCraft üå∏</div>
  <div class="minecraft-container">
    <button class="minecraft-close" id="closeMinecraft">‚úï Close</button>
    <canvas id="gameCanvas" class="minecraft-canvas" width="800" height="500"></canvas>
    
    <!-- Click to Play Overlay (required for pointer lock) -->
    <div class="click-to-play active" id="clickToPlay">
      <div class="click-to-play-text">üéÆ Click to Play</div>
      <div class="click-to-play-hint">Mouse will be captured ‚Ä¢ Press ESC to pause</div>
    </div>
    
    <!-- Pause Menu -->
    <div class="pause-menu" id="pauseMenu">
      <!-- Main Menu -->
      <div class="pause-submenu active" id="menuMain">
        <div class="pause-title">‚è∏ Paused</div>
        <div class="pause-buttons">
          <button class="pause-btn resume" id="btnResume">Resume</button>
          <button class="pause-btn fullscreen" id="btnFullscreen">Fullscreen</button>
          <button class="pause-btn disabled" id="btnAccount">Sign In</button>
          <button class="pause-btn" id="btnStats">Stats</button>
          <button class="pause-btn" id="btnOptions">Options</button>
          <button class="pause-btn quit" id="btnQuit">Quit Game</button>
        </div>
      </div>
      
      <!-- Stats Menu -->
      <div class="pause-submenu" id="menuStats">
        <div class="submenu-title">üìä Statistics</div>
        <div class="submenu-content">
          <div class="stat-row">
            <span>Blocks Placed</span>
            <span class="stat-value" id="statPlaced">0</span>
          </div>
          <div class="stat-row">
            <span>Blocks Broken</span>
            <span class="stat-value" id="statBroken">0</span>
          </div>
          <div class="stat-row">
            <span>Distance Walked</span>
            <span class="stat-value" id="statDistance">0m</span>
          </div>
          <div class="stat-row">
            <span>Jumps</span>
            <span class="stat-value" id="statJumps">0</span>
          </div>
          <div class="stat-row">
            <span>Play Time</span>
            <span class="stat-value" id="statTime">0:00</span>
          </div>
        </div>
        <button class="back-btn" id="statsBack">‚Üê Back</button>
      </div>
      
      <!-- Options Menu -->
      <div class="pause-submenu" id="menuOptions">
        <div class="submenu-title">‚öôÔ∏è Options</div>
        <div class="submenu-content">
          <div class="option-row">
            <span>Brightness</span>
            <input type="range" class="option-slider" id="optBrightness" min="50" max="150" value="100">
          </div>
          <div class="option-row">
            <span>Color Filter</span>
            <select class="option-select" id="optFilter">
              <option value="none">Normal</option>
              <option value="sepia">Sepia</option>
              <option value="grayscale">Black & White</option>
              <option value="trippy">Trippy Hyperbolic</option>
            </select>
          </div>
          <div class="option-row">
            <span>Render Distance</span>
            <select class="option-select" id="optRenderDist">
              <option value="12">Near (Fast)</option>
              <option value="18">Medium</option>
              <option value="25" selected>Far</option>
              <option value="35">Ultra</option>
            </select>
          </div>
          <div class="option-row">
            <span>Shadows</span>
            <div class="option-toggle on" id="optShadows" data-on="true"></div>
          </div>
          <div class="option-row">
            <span>Enhanced Lighting</span>
            <div class="option-toggle on" id="optLighting" data-on="true"></div>
          </div>
          <div class="option-row">
            <span>Anti-Aliasing</span>
            <div class="option-toggle" id="optAA" data-on="false"></div>
          </div>
          <div class="option-row">
            <span>Show FPS</span>
            <div class="option-toggle on" id="optShowFps" data-on="true"></div>
          </div>
          <div class="option-row">
            <span>Target FPS: <span id="targetFpsValue">60</span></span>
            <input type="range" min="15" max="240" value="60" class="option-slider" id="optTargetFps">
          </div>
        </div>
        <button class="back-btn" id="optionsBack">‚Üê Back</button>
      </div>
    </div>
    
    <!-- Inventory Screen -->
    <div class="inventory-screen" id="inventoryScreen">
      <!-- Content populated by JavaScript -->
    </div>
    
    <div class="minecraft-ui" id="gameUI">
      <div class="hotbar-slot selected" data-block="grass"></div>
      <div class="hotbar-slot" data-block="dirt"></div>
      <div class="hotbar-slot" data-block="stone"></div>
      <div class="hotbar-slot" data-block="wood"></div>
      <div class="hotbar-slot" data-block="brick"></div>
      <div class="hotbar-slot" data-item="water_bucket"></div>
      <div class="hotbar-slot" data-item="lava_bucket"></div>
      <div class="hotbar-slot" data-item="ak47"></div>
      <div class="hotbar-slot" data-empty="true"></div>
    </div>
    <div class="pickup-notification" id="pickupNotification"></div>
    
    <!-- Survival HUD -->
    <div id="survivalHUD" style="position:absolute;top:10px;left:10px;color:#fff;font-family:monospace;font-size:14px;text-shadow:1px 1px 2px #000;pointer-events:none;">
      <div id="scoreDisplay">Score: 0</div>
      <div id="waveDisplay">Wave: 1</div>
      <div id="objectiveDisplay"></div>
    </div>
    
    <!-- Debug Console -->
    <div class="debug-console" id="debugConsole">
      <div class="debug-console-header">
        <span>Debug Console (\` to toggle)</span>
        <span id="debugFps">0 FPS</span>
      </div>
      <div class="debug-console-output" id="debugOutput"></div>
      <div class="debug-console-input">
        <span>&gt;</span>
        <input type="text" id="debugInput" placeholder="Type command...">
      </div>
    </div>
    
    <!-- Block Tooltip -->
    <div class="block-tooltip" id="blockTooltip">
      <div class="tooltip-title"></div>
      <div class="tooltip-desc"></div>
    </div>
  </div>
  <div class="minecraft-instructions">
    WASD move | SPACE jump/swim | SHIFT swim down | Q drop | R ritual | SCROLL hotbar | LEFT break | RIGHT use/place | E inventory | \` debug
  </div>
</div>
`;function rt(t=document.body){const i=document.createElement("div");for(i.innerHTML=G;i.firstChild;)t.appendChild(i.firstChild)}const Lt={canvas:null,ctx:null,isActive:!1,isPaused:!1,camera:{x:0,y:50,z:0,rotX:0,rotY:0},velocity:{x:0,y:0,z:0},world:{},keys:{},isJumping:!1,gravity:-.035,lastPos:{x:0,z:0},pointerLocked:!1,inWater:!1,inLava:!1,swimming:!1,headSubmergedWater:!1,headSubmergedLava:!1,playerEyeHeight:1.2,playerHeight:1.8,birds:[],pestBirds:[],blueBirds:[],fish:[],cats:[],creepers:[],selectedSlot:0,selectedBlock:"grass",selectedItem:null,inventory:{hotbar:[{type:"block",id:"grass",count:64},{type:"block",id:"dirt",count:64},{type:"block",id:"stone",count:64},{type:"block",id:"wood",count:64},{type:"block",id:"brick",count:64},{type:"bucket",id:"water_bucket",count:5},{type:"bucket",id:"lava_bucket",count:5},{type:"weapon",id:"ak47",count:1,durability:100,maxDurability:100},null],main:[{type:"block",id:"leaves",count:64},{type:"block",id:"sand",count:64},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],craftingResult:null},recipes:[{ingredients:[{id:"wood",count:4}],result:{type:"block",id:"wood",count:16},name:"Planks"},{ingredients:[{id:"stone",count:8}],result:{type:"block",id:"brick",count:4},name:"Bricks"},{ingredients:[{id:"sand",count:4}],result:{type:"block",id:"stone",count:2},name:"Sandstone"},{ingredients:[{id:"wood",count:8}],result:{type:"block",id:"chest",count:1},name:"Chest"}],fluidUpdates:[],fluidLevels:{},fluidUpdateTimer:0,birdPruneTimer:0,shootCooldown:0,muzzleFlash:0,particles:[],inventoryOpen:!1,draggedItem:null,dragSource:null,stats:{blocksPlaced:0,blocksBroken:0,distance:0,jumps:0,startTime:0},settings:{brightness:100,filter:"none",renderDistance:20,shadows:!0,lighting:!0,antialiasing:!1,showFps:!0,targetFps:60},fpsCounter:{frames:0,lastTime:0,fps:0},noise2D:function(){const t=[];for(let s=0;s<512;s++)t[s]=Math.floor(Math.random()*256);function i(s){return s*s*s*(s*(s*6-15)+10)}function e(s,c,f){return s+f*(c-s)}function a(s,c,f){const h=s&3,n=h<2?c:f,d=h<2?f:c;return(h&1?-n:n)+(h&2?-d:d)}return function(s,c){const f=Math.floor(s)&255,h=Math.floor(c)&255;s-=Math.floor(s),c-=Math.floor(c);const n=i(s),d=i(c),m=t[f]+h,u=t[f+1]+h;return e(e(a(t[m],s,c),a(t[u],s-1,c),n),e(a(t[m+1],s,c-1),a(t[u+1],s-1,c-1),n),d)}}(),fbm(t,i,e=4){let a=0,s=1,c=1,f=0;for(let h=0;h<e;h++)a+=this.noise2D(t*c,i*c)*s,f+=s,s*=.5,c*=2;return a/f},blockColors:{grass:{top:"#7cba5f",side:"#8b6b4a",bottom:"#6b4423"},dirt:{top:"#8b6b4a",side:"#8b6b4a",bottom:"#8b6b4a"},stone:{top:"#888888",side:"#777777",bottom:"#666666"},wood:{top:"#a0825a",side:"#6b4423",bottom:"#6b4423"},leaves:{top:"rgba(50, 180, 50, 0.85)",side:"rgba(40, 160, 40, 0.85)",bottom:"rgba(30, 140, 30, 0.85)",transparent:!0},appleLeaves:{top:"rgba(50, 180, 50, 0.85)",side:"rgba(40, 160, 40, 0.85)",bottom:"rgba(30, 140, 30, 0.85)",transparent:!0},water:{top:"rgba(74, 144, 217, 0.7)",side:"rgba(58, 128, 201, 0.7)",bottom:"rgba(42, 112, 185, 0.7)",transparent:!0,animated:!0},sand:{top:"#e6d9a0",side:"#d9cc93",bottom:"#ccbf86"},brick:{top:"#b35050",side:"#a04040",bottom:"#903030"},lava:{top:"#ff6600",side:"#ff4400",bottom:"#cc3300",animated:!0},obsidian:{top:"#1a0a2e",side:"#140820",bottom:"#0a0410"},cherryWood:{top:"#c4a07a",side:"#8b5a5a",bottom:"#8b5a5a"},cherryLeaves:{top:"rgba(255, 183, 197, 0.85)",side:"rgba(255, 192, 203, 0.85)",bottom:"rgba(255, 144, 165, 0.85)",transparent:!0},chest:{top:"#8b6914",side:"#a0780a",bottom:"#705010"},ritualChest:{top:"#4a0080",side:"#6a00b0",bottom:"#300060"},buildingChest:{top:"#c0c0c0",side:"#a0a0a0",bottom:"#808080"},ritualStone:{top:"#4a4a6a",side:"#3a3a5a",bottom:"#2a2a4a"},petalSocket:{top:"#ffb7c5",side:"#8b5a5a",bottom:"#5a3a3a"},ropeSocket:{top:"#8b7355",side:"#6b5a45",bottom:"#4b3a25"},charmSocket:{top:"#ffd700",side:"#daa520",bottom:"#b8860b"},plaqueSocket:{top:"#deb887",side:"#c4a07a",bottom:"#8b7355"},incenseSocket:{top:"#9370db",side:"#7b68ee",bottom:"#6a5acd"},petalSocketFilled:{top:"#ff69b4",side:"#ff1493",bottom:"#c71585"},ropeSocketFilled:{top:"#daa520",side:"#b8860b",bottom:"#8b6914"},charmSocketFilled:{top:"#fff700",side:"#ffd700",bottom:"#ffb700"},plaqueSocketFilled:{top:"#f4a460",side:"#d2691e",bottom:"#a0522d"},incenseSocketFilled:{top:"#da70d6",side:"#ba55d3",bottom:"#9932cc"},whiteBrick:{top:"#f0f0f0",side:"#e0e0e0",bottom:"#d0d0d0"},redBrick:{top:"#b35050",side:"#a04040",bottom:"#903030"},glowstone:{top:"#ffdd88",side:"#eebb66",bottom:"#ddaa44"}},itemTypes:{grass:{stackable:!0,maxStack:64},dirt:{stackable:!0,maxStack:64},stone:{stackable:!0,maxStack:64},wood:{stackable:!0,maxStack:64},leaves:{stackable:!0,maxStack:64},appleLeaves:{stackable:!0,maxStack:64},sand:{stackable:!0,maxStack:64},brick:{stackable:!0,maxStack:64},cherryWood:{stackable:!0,maxStack:64},cherryLeaves:{stackable:!0,maxStack:64},chest:{stackable:!0,maxStack:16},obsidian:{stackable:!0,maxStack:64},whiteBrick:{stackable:!0,maxStack:64},redBrick:{stackable:!0,maxStack:64},glowstone:{stackable:!0,maxStack:64},ritualStone:{stackable:!0,maxStack:64},apple:{stackable:!0,maxStack:64,throwable:!0,description:"Throw at birds to knock them away"},water_bucket:{stackable:!0,maxStack:16},lava_bucket:{stackable:!0,maxStack:16},ak47:{stackable:!1,maxStack:1,durability:100,maxDurability:100,description:"Shoots bullets at birds"},seeds:{stackable:!0,maxStack:64,description:"Calms angry birds temporarily"},berdger:{stackable:!1,maxStack:1,invincible:!0,description:"The legendary bird repellent - infinite uses!"},sakuraPetal:{stackable:!0,maxStack:16,description:"Sacred cherry blossom petal",ritual:!0},shimenawa:{stackable:!0,maxStack:1,description:"Sacred rope",ritual:!0},omamori:{stackable:!0,maxStack:1,description:"Protective charm base",ritual:!0},ema:{stackable:!0,maxStack:1,description:"Wooden wish plaque",ritual:!0},incense:{stackable:!0,maxStack:1,description:"Purifying incense",ritual:!0}},fluidBlocks:["water","lava"],ritualItems:["sakuraPetal","shimenawa","omamori","ema","incense"],ritualComplete:!1,ritualBlessingActive:!1,ritualBlessingTimer:0,ritualFlight:!1,ritualFlightTimer:0,ritualBarrierActive:!1,init(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.initialized=!1,this.gameLoopId=null,this.lastFrameTime=0},fullInit(){this.initialized||(this.generateWorld(),this.setupControls(),this.setupMenus(),this.setupDebugConsole(),this.initialized=!0,this.updateHotbarDisplay(),setTimeout(()=>this.updateHotbarDisplay(),50),setTimeout(()=>this.updateHotbarDisplay(),150),setTimeout(()=>this.updateHotbarDisplay(),300))},generateWorld(){this.world={},this.fluidLevels={},this.droppedItems=[],this.cherryTrees=[],this.petalParticles=[];const t=50,i=6,e=8;this.worldBounds={minX:-t,maxX:t+1,minZ:-t,maxZ:t+1,minY:0,maxY:50},this.wind={x:0,z:0,targetX:0,targetZ:0,gustTimer:0,strength:.02},this.buildings=[],this.fluidQueue=[];const a={},s={};for(let m=-t;m<=t;m++)for(let u=-t;u<=t;u++){const y=this.fbm(m*.03,u*.03,2)*10,b=this.fbm(m*.05+100,u*.05+100,2)*5,T=Math.sqrt(m*m+u*u)/t,P=Math.max(0,1-T*.5);let L=Math.floor(e+(y+b)*P);L=Math.max(1,Math.min(22,L));const z=`${m},${u}`;a[z]=L,s[z]=this.noise2D(m*.03+500,u*.03+500)}for(let m=-t;m<=t;m++)for(let u=-t;u<=t;u++){const y=`${m},${u}`,b=a[y],T=s[y],P=b<=i+1&&b>=i-1,L=T>.3&&b>i+2;for(let z=Math.max(0,b-3);z<b-1;z++)this.setBlock(m,z,u,"stone");if(P||b<=i?(this.setBlock(m,b-1,u,"sand"),this.setBlock(m,b,u,"sand")):L?(this.setBlock(m,b-1,u,"sand"),this.setBlock(m,b,u,"sand")):(this.setBlock(m,b-1,u,"dirt"),this.setBlock(m,b,u,"grass")),b<i)for(let z=b+1;z<=i;z++)this.setBlock(m,z,u,"water"),this.setFluidLevel(m,z,u,8)}for(let m=-t;m<=t;m+=2)for(let u=-t;u<=t;u+=2){const y=`${m},${u}`,b=a[y],T=s[y],P=b<=i+1,L=T>.3;b>i+1&&!L&&!P&&this.noise2D(m*.4+300,u*.4+300)>.5&&Math.random()<.12&&(Math.random()<.25?this.generateCherryTree(m,b+1,u):this.generateTree(m,b+1,u))}const c=5;for(let m=0;m<c;m++){const u=Math.floor(Math.random()*t*2)-t,y=Math.floor(Math.random()*t*2)-t,b=`${u},${y}`,T=a[b]||e;if(T>i){this.setBlock(u,T+1,y,"ritualChest");const P=this.ritualItems[m%this.ritualItems.length];this.chestContents=this.chestContents||{},this.chestContents[`${u},${T+1},${y}`]=[{type:P,count:1}]}}for(let m=0;m<30;m++){const u=Math.floor(Math.random()*t*2)-t,y=Math.floor(Math.random()*t*2)-t,b=`${u},${y}`,T=a[b]||e;T>i&&this.droppedItems.push({x:u+.5,y:T+1.2,z:y+.5,type:"seeds",count:1+Math.floor(Math.random()*3),bobPhase:Math.random()*Math.PI*2})}if(this.appleTrees){for(const m of this.appleTrees)if(Math.random()<.5){const u=1+Math.floor(Math.random()*3);for(let y=0;y<u;y++)this.droppedItems.push({x:m.x+(Math.random()-.5)*4,y:m.y-3,z:m.z+(Math.random()-.5)*4,type:"apple",count:1,bobPhase:Math.random()*Math.PI*2})}}this.generateBuildings(t);let f,h;do f=Math.floor(Math.random()*(t-20))+15,h=Math.floor(Math.random()*(t-20))+15,Math.random()<.5&&(f=-f),Math.random()<.5&&(h=-h);while(Math.abs(f)<20||Math.abs(h)<20);const n=`${f},${h}`,d=a[n]||e;this.generateRitualTemple(f,d+1,h),this.initBirds(),this.initPestBirds()},generateBuildings(t){const i=["church","house1","house2","house3","grocery","wcdonalds"];let a=!1;for(let s=-Math.floor(t/25);s<=Math.floor(t/25);s++)for(let c=-Math.floor(t/25);c<=Math.floor(t/25);c++){if(s===0&&c===0)continue;const f=s*25,h=c*25,n=2+Math.floor(Math.random()*5);for(let d=0;d<n;d++){const m=f+3+Math.floor(Math.random()*19),u=h+3+Math.floor(Math.random()*19);if(!a&&Math.random()<.3&&this.tryPlaceBuilding(m,u,["wcdonalds"])){a=!0;continue}this.tryPlaceBuilding(m,u,i)}}if(!a)for(let s=0;s<50;s++){const c=25+Math.floor(Math.random()*20),f=25+Math.floor(Math.random()*20);if(this.tryPlaceBuilding(c,f,["wcdonalds"]))break}},tryPlaceBuilding(t,i,e){const a=this.getHighestBlock(t,i);if(!a||a<7)return!1;const s=this.getBlock(t,a,i);if(s==="water"||s==="sand")return!1;const c=this.getHighestBlock(t+3,i)||a,f=this.getHighestBlock(t-3,i)||a,h=this.getHighestBlock(t,i+3)||a,n=this.getHighestBlock(t,i-3)||a;if(Math.max(Math.abs(c-a),Math.abs(f-a),Math.abs(h-a),Math.abs(n-a))>2)return!1;for(const u of this.buildings)if(Math.sqrt((t-u.x)**2+(i-u.z)**2)<15)return!1;const d=e[Math.floor(Math.random()*e.length)],m=a+1;switch(this.buildings.push({x:t,z:i,type:d,y:m}),d){case"church":this.generateChurch(t,m,i);break;case"house1":this.generateHouse1(t,m,i);break;case"house2":this.generateHouse2(t,m,i);break;case"house3":this.generateHouse3(t,m,i);break;case"grocery":this.generateGrocery(t,m,i);break;case"wcdonalds":this.generateWcDonalds(t,m,i);break}return!0},generateChurch(t,i,e){for(let m=0;m<7;m++)for(let u=0;u<12;u++)this.setBlock(t+m,i-1,e+u,"stone");for(let m=0;m<7;m++)for(let u=0;u<12;u++)for(let y=0;y<8;y++)if((m===0||m===6||u===0||u===11)&&Math.random()>.3){if(u===11&&m>=2&&m<=4&&y<3||(m===0||m===6)&&y>=2&&y<=4&&(u===3||u===8))continue;this.setBlock(t+m,i+y,e+u,"stone")}const h=t+3,n=e+2;for(let m=8;m<13;m++)this.setBlock(h,i+m,n,"stone"),m<11&&(Math.random()>.3&&this.setBlock(h+1,i+m,n,"stone"),Math.random()>.3&&this.setBlock(h-1,i+m,n,"stone"));const d=i+8+5;this.setBlock(h,d,n,"stone"),this.setBlock(h,d+1,n,"stone"),this.setBlock(h,d+2,n,"stone"),this.setBlock(h-1,d+1,n,"stone"),this.setBlock(h+1,d+1,n,"stone")},generateHouse1(t,i,e){for(let h=0;h<5;h++)for(let n=0;n<6;n++)this.setBlock(t+h,i-1,e+n,"wood");for(let h=0;h<5;h++)for(let n=0;n<6;n++)for(let d=0;d<4;d++)if((h===0||h===4||n===0||n===5)&&Math.random()>.25){if(n===5&&h===2&&d<2||h===0&&d===1&&n===2)continue;this.setBlock(t+h,i+d,e+n,"wood")}for(let h=-1;h<=5;h++)for(let n=0;n<6;n++)Math.random()>.25&&this.setBlock(t+h,i+4,e+n,"leaves")},generateHouse2(t,i,e){for(let h=0;h<6;h++)for(let n=0;n<7;n++)this.setBlock(t+h,i-1,e+n,"stone");for(let h=0;h<6;h++)for(let n=0;n<7;n++)for(let d=0;d<6;d++)if((h===0||h===5||n===0||n===6)&&Math.random()>.3){if(n===6&&h>=2&&h<=3&&d<2||(h===0||h===5)&&(d===1||d===4)&&(n===2||n===4))continue;this.setBlock(t+h,i+d,e+n,"brick")}for(let h=1;h<5;h++)for(let n=1;n<6;n++)Math.random()>.3*2&&this.setBlock(t+h,i+3,e+n,"wood")},generateHouse3(t,i,e){for(let s=0;s<5;s++)for(let c=0;c<8;c++){this.setBlock(t+s,i-1,e+c,"stone");for(let f=0;f<4;f++)if((s===0||s===4||c===0||c===7)&&Math.random()>.35){if(c===7&&s===2&&f<2)continue;this.setBlock(t+s,i+f,e+c,"brick")}}for(let s=5;s<9;s++)for(let c=0;c<5;c++){this.setBlock(t+s,i-1,e+c,"stone");for(let f=0;f<4;f++)(s===8||c===0||c===4||s===5&&c>4)&&Math.random()>.35&&this.setBlock(t+s,i+f,e+c,"brick")}},generateGrocery(t,i,e){for(let h=0;h<10;h++)for(let n=0;n<8;n++)this.setBlock(t+h,i-1,e+n,"stone");for(let h=0;h<10;h++)for(let n=0;n<8;n++)for(let d=0;d<4;d++)if((h===0||h===9||n===0||n===7)&&Math.random()>.25){if(n===7&&h>=3&&h<=6&&d<3||n===7&&(h===1||h===8)&&d>=1&&d<=2)continue;this.setBlock(t+h,i+d,e+n,"stone")}for(let h=0;h<2;h++)for(let n=2;n<6;n++)Math.random()>.4&&(this.setBlock(t+3+h*3,i,e+n,"wood"),Math.random()>.5&&this.setBlock(t+3+h*3,i+1,e+n,"wood"));for(let h=2;h<8;h++)Math.random()>.3&&this.setBlock(t+h,i+4,e+8-1,"stone")},generateWcDonalds(t,i,e){for(let u=1;u<8;u++)for(let y=1;y<8;y++)for(let b=0;b<6;b++){const T=this.getBlock(t+u,i+b,e+y);T&&T!=="water"&&T!=="lava"&&this.setBlock(t+u,i+b,e+y,null)}for(let u=0;u<9;u++)for(let y=0;y<9;y++)this.setBlock(t+u,i-1,e+y,"brick");for(let u=0;u<9;u++)for(let y=0;y<9;y++)for(let b=0;b<4;b++)if((u===0||u===8||y===0||y===8)&&Math.random()>.2){if(y===8&&u>=3&&u<=5&&b<3||u===8&&y>=2&&y<=4&&b===1)continue;this.setBlock(t+u,i+b,e+y,b<2?"brick":"stone")}const h=t+4,n=e+9,d=i+4;this.setBlock(h-2,d,n,"sand"),this.setBlock(h-2,d+1,n,"sand"),this.setBlock(h-2,d+2,n,"sand"),this.setBlock(h-2,d+3,n,"sand"),this.setBlock(h-1,d,n,"sand"),this.setBlock(h-1,d+1,n,"sand"),this.setBlock(h,d,n,"sand"),this.setBlock(h+1,d,n,"sand"),this.setBlock(h+1,d+1,n,"sand"),this.setBlock(h+2,d,n,"sand"),this.setBlock(h+2,d+1,n,"sand"),this.setBlock(h+2,d+2,n,"sand"),this.setBlock(h+2,d+3,n,"sand");for(let u=2;u<7;u++)Math.random()>.3&&this.setBlock(t+u,i,e+2,"brick");Math.random()>.4&&this.setBlock(t+2,i,e+5,"wood"),Math.random()>.4&&this.setBlock(t+6,i,e+5,"wood"),Math.random()>.4&&this.setBlock(t+4,i,e+6,"wood"),this.setBlock(t+4,i,e+1,"buildingChest"),this.chestContents=this.chestContents||{};const m=`${t+4},${i},${e+1}`;Math.random()<.3?this.chestContents[m]=[{type:"berdger",count:1}]:this.chestContents[m]=[{type:"seeds",count:3+Math.floor(Math.random()*5)}]},getHighestBlock(t,i){for(let e=30;e>=0;e--)if(this.getBlock(t,e,i))return e;return null},initBirds(){this.birds=[];const t=12;for(let i=0;i<t;i++)this.birds.push({x:(Math.random()-.5)*80,y:15+Math.random()*10,z:(Math.random()-.5)*80,baseY:15+Math.random()*10,angle:Math.random()*Math.PI*2,radius:5+Math.random()*15,speed:.01+Math.random()*.02,wobble:Math.random()*Math.PI*2,wobbleSpeed:.05+Math.random()*.05,wingPhase:Math.random()*Math.PI*2,size:.3+Math.random()*.2})},initPestBirds(){this.pestBirds=[];const t=3;for(let i=0;i<t;i++)this.pestBirds.push({x:0,y:12,z:0,vx:0,vy:0,vz:0,targetOffsetX:0,targetOffsetY:0,targetOffsetZ:0,state:"circling",stateTimer:Math.random()*100,angle:i/t*Math.PI*2,circleRadius:2+Math.random(),baseCircleRadius:2+Math.random(),circleSpeed:.08+Math.random()*.04,swoopProgress:0,wingPhase:Math.random()*Math.PI*2,size:.15+Math.random()*.05,chirpTimer:Math.random()*60,knockbackSpin:0,anger:0,timesShot:0,spawnThreshold:4+Math.floor(Math.random()*4)})},updatePestBirds(){const t=this.camera.x,i=this.camera.y,e=this.camera.z;this.seedCalmTimer||(this.seedCalmTimer=0),this.seedCalmTimer>0&&this.seedCalmTimer--;const a=this.seedCalmTimer>0;this.birdPruneTimer||(this.birdPruneTimer=0),this.birdPruneTimer++,this.birdPruneTimer>=1800&&(this.birdPruneTimer=0,this.pestBirds.length>15&&(this.pestBirds.sort((s,c)=>c.anger-s.anger),this.pestBirds=this.pestBirds.slice(0,15)));for(const s of this.pestBirds){s.rageMode&&s.rageTimer&&(s.rageTimer--,s.rageTimer<=0&&(s.rageMode=!1,s.speed=.06)),this.wind&&s.state!=="knockback"&&(s.x+=this.wind.x*.5,s.z+=this.wind.z*.5),a&&s.state!=="knockback"&&(s.state="retreating",s.stateTimer=Math.max(s.stateTimer,60),s.anger=Math.max(0,s.anger-.01)),s.stateTimer--;const c=s.anger*.1;s.wingPhase+=(s.state==="knockback"?.8:.5)+c,s.chirpTimer--;const f=1+s.anger*.3,h=1-s.anger*.1,n=.3+s.anger*.15;if(s.state==="knockback"){const I=s.x,E=s.y,H=s.z;s.x+=s.vx,s.y+=s.vy,s.z+=s.vz;const D=this.getBlock(Math.floor(s.x),Math.floor(s.y),Math.floor(s.z));if(D&&D!=="water"&&D!=="lava")if(D.includes("Leaves")||D.includes("leaves"))s.vx*=.4,s.vy*=.4,s.vz*=.4,s.stateTimer=Math.min(s.stateTimer,90),s.caughtInLeaves=!0;else{const Z=Math.floor(s.x),Y=Math.floor(s.y),q=Math.floor(s.z);this.getBlock(Z,Math.floor(E),Math.floor(H))?this.getBlock(Math.floor(I),Y,Math.floor(H))?this.getBlock(Math.floor(I),Math.floor(E),q)?(s.vx*=-.5,s.vy*=-.5,s.vz*=-.5,s.x=I,s.y=E,s.z=H):(s.vz*=-.7,s.z=H):(s.vy*=-.7,s.y=E):(s.vx*=-.7,s.x=I),this.particles.push({x:s.x,y:s.y,z:s.z,vx:(Math.random()-.5)*.1,vy:Math.random()*.1,vz:(Math.random()-.5)*.1,life:20,type:"spark",size:2})}s.caughtInLeaves?(s.vx*=.9,s.vy*=.9,s.vz*=.9,s.vy+=.01,Math.abs(s.vx)<.01&&Math.abs(s.vz)<.01&&(s.caughtInLeaves=!1)):(s.vx*=.95,s.vy*=.95,s.vy-=.01,s.vz*=.95),s.knockbackSpin+=.3;const Q=Math.sqrt(s.vx*s.vx+s.vy*s.vy+s.vz*s.vz),U=.05+s.anger*.02;if(Q<U||s.stateTimer<=0){if(s.anger=Math.min(5,s.anger+1),s.timesShot++,s.timesShot===s.spawnThreshold&&this.pestBirds.length<15){const X=2+Math.floor(Math.random()*2);for(let Z=0;Z<X;Z++){const Y=Math.random()*Math.PI*2,q=3+Math.random()*2;this.pestBirds.push({x:this.camera.x+Math.cos(Y)*q,y:this.camera.y+1+Math.random(),z:this.camera.z+Math.sin(Y)*q,vx:0,vy:0,vz:0,targetOffsetX:0,targetOffsetY:0,targetOffsetZ:0,state:"circling",stateTimer:20+Math.random()*30,angle:Y,circleRadius:q,baseCircleRadius:q,circleSpeed:.06+Math.random()*.04,swoopProgress:0,wingPhase:Math.random()*Math.PI*2,size:.2+Math.random()*.05,chirpTimer:Math.random()*60,knockbackSpin:0,anger:2+Math.floor(Math.random()*2),timesShot:0,spawnThreshold:4+Math.floor(Math.random()*4)})}}s.state="retreating",s.stateTimer=Math.max(30,120-s.anger*20),s.circleRadius=(s.baseCircleRadius+4)*h,s.vx=s.vy=s.vz=0,s.knockbackSpin=0,s.caughtInLeaves=!1}continue}switch(s.state){case"circling":s.angle+=s.circleSpeed*f,s.targetOffsetX=Math.cos(s.angle)*s.circleRadius*h,s.targetOffsetZ=Math.sin(s.angle)*s.circleRadius*h,s.targetOffsetY=.5+Math.sin(s.angle*2)*.3,s.circleRadius+=(s.baseCircleRadius-s.circleRadius)*.01,s.stateTimer<=0&&(Math.random()<n?(s.state="swooping",s.swoopProgress=0,s.stateTimer=60):Math.random()<.2?(s.state="hovering",s.stateTimer=Math.max(20,40-s.anger*5)+Math.random()*40):s.stateTimer=Math.max(15,30-s.anger*5)+Math.random()*60);break;case"swooping":s.swoopProgress+=.05*f;const I=s.swoopProgress;if(I<.5)s.targetOffsetX=Math.cos(s.angle)*s.circleRadius*(1-I*2),s.targetOffsetZ=Math.sin(s.angle)*s.circleRadius*(1-I*2),s.targetOffsetY=.5-I;else{const D=(I-.5)*2;s.targetOffsetX=Math.cos(s.angle)*s.circleRadius*D,s.targetOffsetZ=Math.sin(s.angle)*s.circleRadius*D,s.targetOffsetY=-.5+D}s.swoopProgress>=1&&(s.state="retreating",s.stateTimer=30);break;case"retreating":s.angle+=s.circleSpeed*.5;const E=s.circleRadius+2;s.targetOffsetX=Math.cos(s.angle)*E,s.targetOffsetZ=Math.sin(s.angle)*E,s.targetOffsetY=1+Math.sin(s.angle*3)*.2,s.circleRadius+=(s.baseCircleRadius-s.circleRadius)*.02,s.stateTimer<=0&&(s.state="circling",s.stateTimer=60+Math.random()*60);break;case"hovering":const H=Math.sin(Date.now()*.01)*.3;s.targetOffsetX=Math.sin(this.camera.rotY+H)*-1.5,s.targetOffsetZ=Math.cos(this.camera.rotY+H)*-1.5,s.targetOffsetY=.2+Math.sin(Date.now()*.02)*.1,s.stateTimer<=0&&(s.state="circling",s.stateTimer=80+Math.random()*40);break}const d=t+s.targetOffsetX,m=i+s.targetOffsetY,u=e+s.targetOffsetZ,y=s.state==="swooping"?.15:.08;let b=(d-s.x)*y,T=(m-s.y)*y,P=(u-s.z)*y;const z=s.rageMode?.12:.08,R=Math.sqrt(b*b+T*T+P*P);if(R>z){const I=z/R;b*=I,T*=I,P*=I}s.x+=b,s.y+=T,s.z+=P}},updateBirds(){for(const t of this.birds)if(t.swarmMode&&t.swarmTimer&&(t.swarmTimer--,t.swarmTimer<=0&&(t.swarmMode=!1)),t.swarmMode){const i=this.camera.x-t.x,e=this.camera.y-t.y,a=this.camera.z-t.z,s=Math.sqrt(i*i+e*e+a*a);s>3?(t.x+=i/s*.15,t.y+=e/s*.1,t.z+=a/s*.15):(t.angle+=.1,t.x=this.camera.x+Math.cos(t.angle)*3,t.z=this.camera.z+Math.sin(t.angle)*3,t.y=this.camera.y+Math.sin(t.wobble)*.5),t.wobble+=t.wobbleSpeed*2,t.wingPhase+=.5}else{t.angle+=t.speed,t.wobble+=t.wobbleSpeed;const i=Math.sin(t.angle*.1)*20,e=Math.cos(t.angle*.1)*20;let a=i+Math.cos(t.angle)*t.radius,s=e+Math.sin(t.angle)*t.radius;this.wind&&(a+=this.wind.x*15,s+=this.wind.z*15),t.x=a,t.z=s,t.y=t.baseY+Math.sin(t.wobble)*2,t.wingPhase+=.3}this.updatePestBirds(),this.updateBlueBirds(),this.updateFish(),this.updateCats(),this.updateCreepers(),this.updateFriendlyBirdDrops(),this.updateBirdEventTimer()},updateBlueBirds(){this.blueBirds||(this.blueBirds=[]);for(let t=this.blueBirds.length-1;t>=0;t--){const i=this.blueBirds[t];i.wingPhase+=.6,i.attackCooldown>0&&i.attackCooldown--;const e=this.camera.x-i.x,a=this.camera.y-i.y,s=this.camera.z-i.z,c=Math.sqrt(e*e+a*a+s*s);c>1.5&&(i.vx+=e/c*.02,i.vy+=a/c*.015,i.vz+=s/c*.02),i.x+=i.vx,i.y+=i.vy,i.z+=i.vz,i.vx*=.9,i.vy*=.9,i.vz*=.9,c<2&&i.attackCooldown<=0&&(this.velocity.x+=(this.camera.x-i.x)*.1,this.velocity.y+=.15,this.velocity.z+=(this.camera.z-i.z)*.1,i.attackCooldown=60),c>60&&this.blueBirds.splice(t,1)}},updateFish(){this.fish||(this.fish=[]);for(let t=this.fish.length-1;t>=0;t--){const i=this.fish[t];i.swimPhase+=.15,this.getBlock(Math.floor(i.x),Math.floor(i.y),Math.floor(i.z))!=="water"?i.vy-=.01:(i.vx+=(Math.random()-.5)*.01,i.vz+=(Math.random()-.5)*.01,i.vy+=(Math.random()-.5)*.005),i.x+=i.vx,i.y+=i.vy,i.z+=i.vz,i.vx*=.95,i.vy*=.95,i.vz*=.95;const a=Math.sqrt(i.vx*i.vx+i.vz*i.vz);a>.08&&(i.vx=i.vx/a*.08,i.vz=i.vz/a*.08)}},updateCats(){this.cats||(this.cats=[]);for(const t of this.cats){t.walkPhase+=.1,t.meowTimer--;const i=this.camera.x-t.x,e=this.camera.z-t.z,a=Math.sqrt(i*i+e*e);a>t.followDistance+2?(t.state="following",t.vx+=i/a*.01,t.vz+=e/a*.01):a<t.followDistance&&(t.state="idle"),t.x+=t.vx,t.z+=t.vz,t.vx*=.85,t.vz*=.85,t.vy-=.02,t.y+=t.vy;const s=Math.floor(t.y);this.getBlock(Math.floor(t.x),s,Math.floor(t.z))&&(t.y=s+1,t.vy=0),t.meowTimer<=0&&(t.meowTimer=200+Math.random()*400)}},updateCreepers(){this.creepers||(this.creepers=[]);for(let t=this.creepers.length-1;t>=0;t--){const i=this.creepers[t];i.walkPhase+=.08;const e=this.camera.x-i.x,a=this.camera.z-i.z,s=Math.sqrt(e*e+a*a);if(i.state==="stalking")s>2?(i.vx+=e/s*.003,i.vz+=a/s*.003):(i.state="fusing",i.fuseTimer=0);else if(i.state==="fusing"){if(i.fuseTimer++,i.flashing=Math.floor(i.fuseTimer/5)%2===0,i.fuseTimer>=i.fuseMax){this.creeperExplode(i),this.creepers.splice(t,1);continue}s>4&&(i.state="stalking",i.fuseTimer=0)}i.x+=i.vx,i.z+=i.vz,i.vx*=.9,i.vz*=.9,i.vy-=.02,i.y+=i.vy;const c=Math.floor(i.y);this.getBlock(Math.floor(i.x),c,Math.floor(i.z))&&(i.y=c+1,i.vy=0)}},creeperExplode(t){const i=this.camera.x-t.x,e=this.camera.z-t.z,a=Math.sqrt(i*i+e*e);if(a<6){const s=(6-a)/6*1.5;this.velocity.x+=i/a*s,this.velocity.y+=.8,this.velocity.z+=e/a*s}for(let s=0;s<30;s++)this.particles.push({x:t.x,y:t.y+.5,z:t.z,vx:(Math.random()-.5)*.3,vy:Math.random()*.3,vz:(Math.random()-.5)*.3,life:30+Math.random()*20,type:"explosion",size:3+Math.random()*3});for(let s=0;s<5;s++)this.spawnBlueBird();this.birdEvent&&this.showBirdAlert("üí• CREEPER EXPLODED! Blue birds incoming! üí•")},updateFriendlyBirdDrops(){if(this.birdDropTimer||(this.birdDropTimer=0),this.birdDropTimer++,this.birdDropTimer>=600){this.birdDropTimer=0;for(const t of this.birds)if(Math.random()<.3){const i=Math.random();let e="seeds",a=1+Math.floor(Math.random()*3);i<.05?(e=["berdger","omamori","shimenawa"][Math.floor(Math.random()*3)],a=1):i<.2&&(e="apple",a=1+Math.floor(Math.random()*2)),this.dropItem(t.x+(Math.random()-.5)*2,t.y-2,t.z+(Math.random()-.5)*2,e,a);break}}},updateBirdEventTimer(){if(!this.birdEvent)return;const t=Date.now(),i=t-this.birdEvent.lastUpdate;this.birdEvent.lastUpdate=t,this.birdEvent.timer-=i,this.birdEvent.alertFade>0&&(this.birdEvent.alertFade-=i,this.birdEvent.alertFade<=0&&(this.birdEvent.alertMessage=null));const e=this.birdEvent.timer,a=this.birdEvent.events[this.birdEvent.currentEvent];e<=5*60*1e3&&e>4*60*1e3&&!this.birdEvent.alertShown.five&&(this.showBirdAlert(`‚ö†Ô∏è In 5 minutes, ${a.description} ‚ö†Ô∏è`),this.birdEvent.alertShown.five=!0),e<=3*60*1e3&&e>2*60*1e3&&!this.birdEvent.alertShown.three&&(this.showBirdAlert(`‚ö†Ô∏è In 3 minutes, ${a.description} ‚ö†Ô∏è`),this.birdEvent.alertShown.three=!0),e<=1*60*1e3&&e>50*1e3&&!this.birdEvent.alertShown.one&&(this.showBirdAlert(`‚ö†Ô∏è In 1 minute, ${a.description} ‚ö†Ô∏è`),this.birdEvent.alertShown.one=!0),e<=30*1e3&&e>20*1e3&&!this.birdEvent.alertShown.thirty&&(this.showBirdAlert(`‚ö†Ô∏è In 30 seconds, ${a.description.toUpperCase()} ‚ö†Ô∏è`),this.birdEvent.alertShown.thirty=!0),e<=10*1e3&&e>5*1e3&&!this.birdEvent.alertShown.ten&&(this.showBirdAlert(`üî• In 10 seconds, ${a.description.toUpperCase()} üî•`),this.birdEvent.alertShown.ten=!0),e<=0&&this.triggerBirdEvent()},showBirdAlert(t){this.birdEvent.alertMessage=t,this.birdEvent.alertFade=4e3},triggerBirdEvent(){const t=this.birdEvent.events[this.birdEvent.currentEvent];this.showBirdAlert(`üê¶ BIRD EVENT: ${t.name}! üê¶`),t.action(),this.birdEvent.timer=5*60*1e3,this.birdEvent.currentEvent=(this.birdEvent.currentEvent+1)%this.birdEvent.events.length,this.birdEvent.alertShown={five:!1,three:!1,one:!1,thirty:!1,ten:!1}},triggerBirdSwarm(){for(const t of this.birds)t.swarmMode=!0,t.swarmTimer=30*60;for(let t=0;t<5;t++)this.spawnPestBird()},triggerBirdRage(){if(this.pestBirds)for(const t of this.pestBirds)t.rageMode=!0,t.rageTimer=45*60,t.speed=(t.speed||.06)*1.5;for(let t=0;t<3;t++){const i=this.spawnPestBird();i&&(i.rageMode=!0,i.rageTimer=45*60)}},triggerBirdMultiply(){for(let t=0;t<10;t++){const i=Math.random()*Math.PI*2,e=10+Math.random()*20,a=this.spawnPestBird();a&&(a.x=this.camera.x+Math.cos(i)*e,a.z=this.camera.z+Math.sin(i)*e,a.y=this.camera.y+5+Math.random()*10)}},triggerCreeperInvasion(){this.showBirdAlert("üí• CREEPERS ARE STALKING YOU! üí•");const t=2+Math.floor(Math.random()*3);for(let i=0;i<t;i++)this.spawnCreeper()},spawnPestBird(){this.pestBirds||(this.pestBirds=[]);const t={x:this.camera.x+(Math.random()-.5)*30,y:this.camera.y+10+Math.random()*10,z:this.camera.z+(Math.random()-.5)*30,vx:0,vy:0,vz:0,state:"hunting",wingPhase:Math.random()*Math.PI*2,speed:.06,angryTimer:60*60*5};return this.pestBirds.push(t),t},spawnBlueBird(){this.blueBirds||(this.blueBirds=[]);const t={x:this.camera.x+(Math.random()-.5)*20,y:this.camera.y+5+Math.random()*8,z:this.camera.z+(Math.random()-.5)*20,vx:0,vy:0,vz:0,state:"aggressive",wingPhase:Math.random()*Math.PI*2,speed:.1,attackCooldown:0};return this.blueBirds.push(t),t},spawnFish(){this.fish||(this.fish=[]);let t=null;for(let e=0;e<50;e++){const a=Math.floor(this.camera.x+(Math.random()-.5)*40),s=Math.floor(this.camera.z+(Math.random()-.5)*40);for(let c=20;c>=0;c--)if(this.getBlock(a,c,s)==="water"){t={x:a+.5,y:c+.5,z:s+.5};break}if(t)break}t||(t={x:this.camera.x+(Math.random()-.5)*10,y:7,z:this.camera.z+(Math.random()-.5)*10});const i={x:t.x,y:t.y,z:t.z,vx:(Math.random()-.5)*.05,vy:0,vz:(Math.random()-.5)*.05,swimPhase:Math.random()*Math.PI*2,color:Math.random()>.5?"#ff6347":"#ffd700",size:.3+Math.random()*.2};return this.fish.push(i),i},spawnCat(){this.cats||(this.cats=[]);const t={x:this.camera.x+(Math.random()-.5)*10,y:this.camera.y-1,z:this.camera.z+(Math.random()-.5)*10,vx:0,vy:0,vz:0,state:"idle",walkPhase:0,color:["#ffa500","#808080","#000000","#ffffff"][Math.floor(Math.random()*4)],meowTimer:Math.random()*300+200,followDistance:3+Math.random()*2};return this.cats.push(t),t},spawnCreeper(){this.creepers||(this.creepers=[]);const t={x:this.camera.x+(Math.random()>.5?15:-15)+(Math.random()-.5)*10,y:this.camera.y,z:this.camera.z+(Math.random()>.5?15:-15)+(Math.random()-.5)*10,vx:0,vy:0,vz:0,state:"stalking",fuseTimer:0,fuseMax:90,walkPhase:0,health:3};return this.creepers.push(t),t},updateSurvivalHUD(){if(!this.survivalStats)return;const t=document.getElementById("scoreDisplay"),i=document.getElementById("waveDisplay"),e=document.getElementById("objectiveDisplay");t&&(t.textContent=`Score: ${this.survivalStats.score}`),i&&(i.textContent=`Wave: ${this.survivalStats.wave}`),e&&this.survivalStats.currentObjective&&(e.textContent=`Objective: ${this.survivalStats.currentObjective.text}`)},generateRitualTemple(t,i,e){this.ritualTempleLocation={x:t,y:i,z:e};for(let n=0;n<11;n++)for(let d=0;d<11;d++)for(let m=0;m<10;m++)this.setBlock(t+n,i+m,e+d,null);for(let n=0;n<11;n++)for(let d=0;d<11;d++)this.setBlock(t+n,i,e+d,"ritualStone");for(let n=1;n<8;n++){for(let d=0;d<11;d++)this.setBlock(t+d,i+n,e,"ritualStone"),this.setBlock(t+d,i+n,e+11-1,"ritualStone");for(let d=0;d<11;d++)this.setBlock(t,i+n,e+d,"ritualStone"),this.setBlock(t+11-1,i+n,e+d,"ritualStone")}this.setBlock(t+11/2|0,i+1,e,null),this.setBlock(t+11/2|0,i+2,e,null),this.setBlock(t+11/2|0,i+3,e,null);const f=t+11/2|0,h=e+11/2|0;this.setBlock(f,i+1,h,"charmSocket"),this.setBlock(f-2,i+1,h,"petalSocket"),this.setBlock(f+2,i+1,h,"ropeSocket"),this.setBlock(f,i+1,h-2,"plaqueSocket"),this.setBlock(f,i+1,h+2,"incenseSocket");for(let n=1;n<=4;n++)this.setBlock(t+2,i+n,e+2,"glowstone"),this.setBlock(t+11-3,i+n,e+2,"glowstone"),this.setBlock(t+2,i+n,e+11-3,"glowstone"),this.setBlock(t+11-3,i+n,e+11-3,"glowstone")},generateTree(t,i,e){for(let a=0;a<4;a++)this.setBlock(t,i+a,e,"wood");for(let a=-2;a<=2;a++)for(let s=-2;s<=2;s++)for(let c=3;c<=5;c++)Math.abs(a)+Math.abs(s)+Math.abs(c-4)<4&&(a===0&&s===0&&c<4||this.setBlock(t+a,i+c,e+s,"appleLeaves"));this.appleTrees||(this.appleTrees=[]),this.appleTrees.push({x:t,y:i+4,z:e})},generateCherryTree(t,i,e){for(let a=0;a<6;a++)this.setBlock(t,i+a,e,"cherryWood");for(let a=-3;a<=3;a++)for(let s=-3;s<=3;s++)for(let c=4;c<=8;c++)Math.abs(a)+Math.abs(s)+Math.abs(c-6)<5&&Math.random()>.15&&(a===0&&s===0&&c<5||this.setBlock(t+a,i+c,e+s,"cherryLeaves"));this.cherryTrees.push({x:t,y:i+6,z:e})},setBlock(t,i,e,a){const s=`${t},${i},${e}`;a===null?delete this.world[s]:this.world[s]=a},getBlock(t,i,e){return this.world[`${t},${i},${e}`]||null},setupControls(){document.addEventListener("keydown",i=>{if(!this.isActive)return;if(i.key==="Escape"){if(i.preventDefault(),this.inventoryOpen){this.toggleInventory();return}this.isPaused?this.resume():this.pause();return}if(this.isPaused)return;this.keys[i.key.toLowerCase()]=!0;const a=["1","2","3","4","5","6","7","8","9"].indexOf(i.key);if(a!==-1){this.selectedSlot=a;const s=this.inventory.hotbar[a];s&&(s.type==="block"?(this.selectedBlock=s.id,this.selectedItem=null):s.type==="weapon"&&(this.selectedItem=s.id,this.selectedBlock=null)),this.updateHotbar()}if(i.key.toLowerCase()==="e"&&this.toggleInventory(),i.key.toLowerCase()==="q"&&this.dropHeldItem(),i.key.toLowerCase()==="r"&&this.checkRitual()&&console.log("Omamori Ritual Complete! Birds are blessed and calmed."),i.key==="`"||i.key==="~"){i.preventDefault(),this.toggleDebugConsole();return}i.preventDefault()}),document.addEventListener("keyup",i=>{this.keys[i.key.toLowerCase()]=!1}),this.pointerLocked=!1,document.addEventListener("pointerlockchange",()=>{this.pointerLocked=document.pointerLockElement===this.canvas,this.pointerLocked?document.getElementById("clickToPlay").classList.remove("active"):this.isActive&&!this.isPaused&&!this.inventoryOpen&&!this.justClosedInventory&&this.pause()}),document.addEventListener("pointerlockerror",()=>{console.log("Pointer lock failed"),this.isActive&&!this.isPaused&&document.getElementById("clickToPlay").classList.add("active")}),this.canvas.addEventListener("mousedown",i=>{if(!(!this.isActive||this.isPaused)&&!this.inventoryOpen){if(!this.pointerLocked){this.canvas.requestPointerLock();return}if(i.button===0){const e=this.raycast();if(e&&e.hit){const a=this.getBlock(e.hit.x,e.hit.y,e.hit.z);if(a==="water"||a==="lava")return;const s=f=>f&&(f==="chest"||f==="ritualChest"||f==="buildingChest"||f.toLowerCase().includes("chest"));if((f=>f&&f.includes("Socket"))(a))return;if(this.setBlock(e.hit.x,e.hit.y,e.hit.z,null),this.stats.blocksBroken++,this.survivalStats&&(this.survivalStats.score+=1,this.updateSurvivalHUD()),a&&!s(a))a==="appleLeaves"?(this.dropItem(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5,"appleLeaves",1),Math.random()<.15&&this.dropItem(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5,"apple",1)):a==="cherryLeaves"?(this.dropItem(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5,"cherryLeaves",1),Math.random()<.1&&this.dropItem(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5,"sakuraPetal",1)):this.dropItem(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5,a,1);else if(s(a)){const f=`${e.hit.x},${e.hit.y},${e.hit.z}`,h=this.chestContents&&this.chestContents[f];if(h&&Array.isArray(h)){for(const n of h)n&&n.type&&this.dropItem(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5,n.type,n.count||1);delete this.chestContents[f]}this.dropItem(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5,"chest",1)}}}else if(i.button===2){const e=this.raycast();if(e&&e.hit){const c=this.getBlock(e.hit.x,e.hit.y,e.hit.z);if(c&&(c==="chest"||c==="ritualChest"||c==="buildingChest"||c.toLowerCase().includes("chest"))){this.openChest(e.hit.x,e.hit.y,e.hit.z);return}if(c&&c.includes("Socket")){this.interactWithSocket(e.hit.x,e.hit.y,e.hit.z,c);return}}const a=this.inventory.hotbar[this.selectedSlot],s=a?a.id:null;if(this.selectedItem==="ak47")this.shootAK47();else if(s==="berdger")this.shootBerdger();else if(s==="apple")this.throwApple();else if(s==="seeds")this.useSeeds();else if(this.selectedItem==="water_bucket"||this.selectedItem==="lava_bucket"){const c=this.raycast();if(c&&c.place){const f=this.selectedItem==="water_bucket"?"water":"lava",h=c.place,n=Math.floor(this.camera.x),d=Math.floor(this.camera.z),m=Math.floor(this.camera.y-this.playerEyeHeight),u=Math.floor(this.camera.y-this.playerEyeHeight+this.playerHeight);let y=!1;for(let b=m;b<=u;b++)if(n===h.x&&b===h.y&&d===h.z){y=!0;break}if(!y){this.setBlock(h.x,h.y,h.z,f),this.setFluidLevel(h.x,h.y,h.z,8),this.fluidUpdates.push({x:h.x,y:h.y,z:h.z,type:f,level:8});const b=this.inventory.hotbar[this.selectedSlot];b&&b.count>1?b.count--:(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbar()}}}else if(this.selectedBlock){const c=this.raycast();if(c&&c.place){const f=Math.floor(this.camera.x),h=Math.floor(this.camera.z),n=c.place,d=Math.floor(this.camera.y-this.playerEyeHeight),m=Math.floor(this.camera.y-this.playerEyeHeight+this.playerHeight);let u=!1;for(let y=d;y<=m;y++)if(f===n.x&&y===n.y&&h===n.z){u=!0;break}if(!u){this.setBlock(n.x,n.y,n.z,this.selectedBlock),this.stats.blocksPlaced++;const y=this.inventory.hotbar[this.selectedSlot];y&&y.count>0&&(y.count--,y.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedBlock=null),this.updateHotbarDisplay())}}}}}}),this.canvas.addEventListener("contextmenu",i=>{i.preventDefault()}),this.canvas.addEventListener("wheel",i=>{if(!this.isActive||this.isPaused||this.inventoryOpen)return;i.preventDefault(),i.deltaY>0?this.selectedSlot=(this.selectedSlot+1)%9:i.deltaY<0&&(this.selectedSlot=(this.selectedSlot+8)%9);const e=this.inventory.hotbar[this.selectedSlot];e?e.type==="block"?(this.selectedBlock=e.id,this.selectedItem=null):e.type==="weapon"?(this.selectedItem=e.id,this.selectedBlock=null):e.type==="bucket"&&(this.selectedItem=e.id,this.selectedBlock=null):(this.selectedBlock=null,this.selectedItem=null),this.updateHotbar()},{passive:!1}),document.getElementById("minecraftGame").addEventListener("wheel",i=>{this.isActive&&(i.preventDefault(),i.stopPropagation())},{passive:!1}),document.addEventListener("mousemove",i=>{!this.isActive||this.isPaused||!this.pointerLocked||(this.camera.rotY-=i.movementX*.003,this.camera.rotX=Math.max(-1.5,Math.min(1.5,this.camera.rotX+i.movementY*.003)))}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.isActive&&!this.isPaused&&this.pause()}),window.addEventListener("resize",()=>{(document.fullscreenElement||document.webkitFullscreenElement)&&this.isActive&&(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight)}),document.querySelectorAll(".hotbar-slot").forEach((i,e)=>{i.addEventListener("click",a=>{a.stopPropagation(),this.selectedSlot=e;const s=this.inventory.hotbar[e];s&&(s.type==="block"?(this.selectedBlock=s.id,this.selectedItem=null):s.type==="weapon"&&(this.selectedItem=s.id,this.selectedBlock=null)),this.updateHotbar()})})},setupMenus(){document.getElementById("btnResume").addEventListener("click",()=>this.resume()),document.getElementById("btnFullscreen").addEventListener("click",t=>{t.preventDefault();const i=document.getElementById("minecraftGame");document.fullscreenElement||document.webkitFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():i.requestFullscreen?i.requestFullscreen().catch(a=>console.log("Fullscreen error:",a)):i.webkitRequestFullscreen&&i.webkitRequestFullscreen(),this.resume()}),document.addEventListener("fullscreenchange",()=>this.updateFullscreenButton()),document.addEventListener("webkitfullscreenchange",()=>this.updateFullscreenButton()),document.getElementById("btnAccount").addEventListener("click",t=>{t.preventDefault()}),document.getElementById("btnStats").addEventListener("click",()=>{this.showSubmenu("menuStats"),this.updateStatsDisplay()}),document.getElementById("btnOptions").addEventListener("click",()=>{this.showSubmenu("menuOptions")}),document.getElementById("btnQuit").addEventListener("click",()=>this.stop()),document.getElementById("statsBack").addEventListener("click",()=>this.showSubmenu("menuMain")),document.getElementById("optionsBack").addEventListener("click",()=>this.showSubmenu("menuMain")),document.getElementById("optBrightness").addEventListener("input",t=>{this.settings.brightness=parseInt(t.target.value),this.applyFilters()}),document.getElementById("optFilter").addEventListener("change",t=>{this.settings.filter=t.target.value,this.applyFilters()}),document.getElementById("optRenderDist").addEventListener("change",t=>{this.settings.renderDistance=parseInt(t.target.value)}),["optShadows","optLighting","optAA","optShowFps"].forEach(t=>{document.getElementById(t).addEventListener("click",i=>{const e=i.target,a=e.dataset.on==="true";e.dataset.on=(!a).toString(),e.classList.toggle("on",!a),t==="optShadows"&&(this.settings.shadows=!a),t==="optLighting"&&(this.settings.lighting=!a),t==="optAA"&&(this.settings.antialiasing=!a,this.canvas.style.imageRendering=a?"auto":"pixelated"),t==="optShowFps"&&(this.settings.showFps=!a)})}),document.getElementById("optTargetFps").addEventListener("input",t=>{const i=parseInt(t.target.value);this.settings.targetFps=i,document.getElementById("targetFpsValue").textContent=String(i)})},showSubmenu(t){document.querySelectorAll(".pause-submenu").forEach(i=>i.classList.remove("active")),document.getElementById(t).classList.add("active")},updateStatsDisplay(){document.getElementById("statPlaced").textContent=this.stats.blocksPlaced,document.getElementById("statBroken").textContent=this.stats.blocksBroken,document.getElementById("statDistance").textContent=String(Math.floor(this.stats.distance))+"m",document.getElementById("statJumps").textContent=this.stats.jumps;const t=Math.floor((Date.now()-this.stats.startTime)/1e3),i=Math.floor(t/60),e=t%60;document.getElementById("statTime").textContent=`${i}:${e.toString().padStart(2,"0")}`},applyFilters(){let t=`brightness(${this.settings.brightness}%)`;switch(this.settings.filter){case"sepia":t+=" sepia(80%)";break;case"grayscale":t+=" grayscale(100%)";break;case"trippy":t+=" hue-rotate("+Date.now()%3600/10+"deg) saturate(200%)";break}this.canvas.style.filter=t},updateHotbar(){document.querySelectorAll(".hotbar-slot").forEach((i,e)=>{const a=e===this.selectedSlot;i.classList.toggle("selected",a)})},updateHotbarDisplay(){document.querySelectorAll(".hotbar-slot").forEach((i,e)=>{const a=this.inventory.hotbar[e],s=e===this.selectedSlot;i.classList.toggle("selected",s),a&&a.count?i.setAttribute("data-count",a.count):i.setAttribute("data-count","");let c=i.querySelector("canvas");if(c||(c=document.createElement("canvas"),c.width=32,c.height=32,c.style.width="100%",c.style.height="100%",c.style.position="absolute",c.style.top="2px",c.style.left="2px",i.appendChild(c)),a){this.drawMiniBlock(c,a.id);let f=i.querySelector(".durability-bar");if(a.durability!==void 0&&a.maxDurability){f||(f=document.createElement("div"),f.className="durability-bar",f.innerHTML='<div class="durability-fill"></div>',i.appendChild(f));const h=f.querySelector(".durability-fill"),n=a.durability/a.maxDurability*100;h.style.width=n+"%",h.style.backgroundColor=n>50?"#4a4":n>25?"#aa4":"#a44",f.style.display="block"}else f&&(f.style.display="none")}else{c.getContext("2d").clearRect(0,0,c.width,c.height);const h=i.querySelector(".durability-bar");h&&(h.style.display="none")}})},shootAK47(){if(this.shootCooldown>0)return;const t=this.inventory.hotbar[this.selectedSlot];if(t&&t.id==="ak47"){if(t.durability!==void 0&&t.durability<=0)return;t.durability!==void 0&&(t.durability--,t.durability<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null,this.showPickupNotification("ak47",-1)),this.updateHotbarDisplay())}this.shootCooldown=8,this.muzzleFlash=5;const i=this.camera.rotX,e=this.camera.rotY,a=-Math.sin(e)*Math.cos(i),s=-Math.sin(i),c=Math.cos(e)*Math.cos(i),f=2.5,h={x:this.camera.x+a*.5,y:this.camera.y+s*.5,z:this.camera.z+c*.5,vx:a*f,vy:s*f,vz:c*f,life:60,type:"bullet",trail:[]};this.particles.push(h);const n=.8;let d=null,m=1/0;for(const u of this.pestBirds){const y=u.x-this.camera.x,b=u.y-this.camera.y,T=u.z-this.camera.z,P=Math.sqrt(y*y+b*b+T*T);if(P<15&&P<m){const L=y/P,z=b/P,R=T/P;a*L+s*z+c*R>.9&&(d=u,m=P)}}if(d){d.vx=a*n+(Math.random()-.5)*.2,d.vy=s*n+.3+Math.random()*.2,d.vz=c*n+(Math.random()-.5)*.2,d.state="knockback",d.stateTimer=90;for(let z=0;z<8;z++){const R=.15+Math.random()*.2,I=-a*.5+(Math.random()-.5)*1.5,E=Math.random()*.8+.2,H=-c*.5+(Math.random()-.5)*1.5,D=Math.sqrt(I*I+E*E+H*H);this.particles.push({x:d.x,y:d.y,z:d.z,vx:I/D*R,vy:E/D*R,vz:H/D*R,life:25+Math.random()*20,type:"ricochet",size:2+Math.random()*3})}for(let z=0;z<5;z++)this.particles.push({x:d.x+(Math.random()-.5)*.3,y:d.y+(Math.random()-.5)*.3,z:d.z+(Math.random()-.5)*.3,vx:(Math.random()-.5)*.1,vy:.05+Math.random()*.05,vz:(Math.random()-.5)*.1,life:40+Math.random()*30,type:"feather",rotation:Math.random()*Math.PI*2,rotSpeed:(Math.random()-.5)*.3});const u=.08+Math.random()*.05;this.velocity.y+=.05+Math.random()*.03;const y=d.x-this.camera.x,b=d.z-this.camera.z,T=Math.sqrt(y*y+b*b);T>.1&&(this.camera.x-=y/T*u*.3+(Math.random()-.5)*u,this.camera.z-=b/T*u*.3+(Math.random()-.5)*u);const P=Math.random();let L=0;P<.01?L=20:P<.1&&(L=5);for(let z=0;z<L;z++){const R=Math.random()*Math.PI*2,I=2+Math.random()*3;this.pestBirds.push({x:d.x+Math.cos(R)*I,y:d.y+(Math.random()-.5)*2,z:d.z+Math.sin(R)*I,vx:0,vy:0,vz:0,targetOffsetX:0,targetOffsetY:0,targetOffsetZ:0,state:"circling",stateTimer:10+Math.random()*20,angle:R,circleRadius:I,baseCircleRadius:I,circleSpeed:.07+Math.random()*.05,swoopProgress:0,wingPhase:Math.random()*Math.PI*2,size:.15+Math.random()*.08,chirpTimer:Math.random()*30,knockbackSpin:0,anger:1+Math.floor(Math.random()*3),timesShot:0,spawnThreshold:4+Math.floor(Math.random()*4)})}}for(const u of this.birds){const y=u.x-this.camera.x,b=u.y-this.camera.y,T=u.z-this.camera.z,P=Math.sqrt(y*y+b*b+T*T);if(P<25){const L=y/P,z=b/P,R=T/P;if(a*L+s*z+c*R>.85){u.radius+=8,u.baseY+=5;for(let E=0;E<5;E++)this.particles.push({x:u.x,y:u.y,z:u.z,vx:(Math.random()-.5)*.3,vy:Math.random()*.2,vz:(Math.random()-.5)*.3,life:20+Math.random()*15,type:"ricochet",size:2+Math.random()*2})}}}},updateParticles(){for(let t=this.particles.length-1;t>=0;t--){const i=this.particles[t];if(i.life--,i.life<=0){this.particles.splice(t,1);continue}if(i.x+=i.vx,i.y+=i.vy,i.z+=i.vz,i.type==="bullet"){i.trail.push({x:i.x,y:i.y,z:i.z}),i.trail.length>8&&i.trail.shift();const e=Math.floor(i.x),a=Math.floor(i.y),s=Math.floor(i.z);if(this.getBlock(e,a,s)){for(let c=0;c<6;c++)this.particles.push({x:i.x,y:i.y,z:i.z,vx:(Math.random()-.5)*.2,vy:Math.random()*.15,vz:(Math.random()-.5)*.2,life:15+Math.random()*10,type:"spark",size:2+Math.random()*2});this.particles.splice(t,1)}}else if(i.type==="ricochet"||i.type==="spark")i.vy-=.008,i.vx*=.97,i.vz*=.97;else if(i.type==="feather")i.vy-=.002,i.vx*=.98,i.vz*=.98,i.rotation+=i.rotSpeed;else if(i.type==="burger"){i.vy-=.003;for(const e of this.pestBirds){const a=e.x-i.x,s=e.y-i.y,c=e.z-i.z,f=Math.sqrt(a*a+s*s+c*c);if(f<1.5){e.vx=i.vx*.5+a/f*2.5,e.vy=Math.abs(i.vy)+.5,e.vz=i.vz*.5+c/f*2.5,e.state="knockback",e.stateTimer=120,e.anger=Math.min(5,e.anger+2),i.life=0;for(let n=0;n<8;n++)this.particles.push({x:i.x,y:i.y,z:i.z,vx:(Math.random()-.5)*.3,vy:Math.random()*.2,vz:(Math.random()-.5)*.3,life:20,type:"burgerSplat",size:3+Math.random()*3})}}}else if(i.type==="burgerSplat")i.vy-=.01,i.vx*=.95,i.vz*=.95;else if(i.type==="apple"){i.vy+=i.gravity||-.008;for(const a of this.pestBirds){const s=a.x-i.x,c=a.y-i.y,f=a.z-i.z,h=Math.sqrt(s*s+c*c+f*f);if(h<1.5){a.vx=i.vx*.5+s/h*3,a.vy=.8,a.vz=i.vz*.5+f/h*3,a.state="knockback",a.stateTimer=180,a.anger=Math.max(0,a.anger-.5),i.life=0,this.survivalStats&&(this.survivalStats.score+=50,this.updateSurvivalHUD());for(let d=0;d<6;d++)this.particles.push({x:i.x,y:i.y,z:i.z,vx:(Math.random()-.5)*.3,vy:Math.random()*.2,vz:(Math.random()-.5)*.3,life:15,type:"appleSplat",size:2+Math.random()*2})}}for(const a of this.birds)if(a.swarmMode){const s=a.x-i.x,c=a.y-i.y,f=a.z-i.z;Math.sqrt(s*s+c*c+f*f)<2&&(a.swarmMode=!1,a.swarmTimer=0,i.life=0,this.survivalStats&&(this.survivalStats.score+=25,this.updateSurvivalHUD()))}const e=this.getGroundHeightBelow(i.x,i.z,i.y+10);i.y<=e+.5&&(i.life=0)}else i.type==="appleSplat"?(i.vy-=.015,i.vx*=.9,i.vz*=.9):i.type==="petal"&&(i.vy-=8e-4,i.vx+=this.wind.x*.15,i.vz+=this.wind.z*.15,i.vx*=.985,i.vz*=.985,i.rotation+=i.rotSpeed+this.wind.x*.08,i.flutter+=i.flutterSpeed||.08,i.x+=Math.sin(i.flutter)*.025,i.y+=Math.cos(i.flutter*1.3)*.008,i.z+=Math.cos(i.flutter*.7)*.015,i.y<this.getGroundHeightBelow(i.x,i.z,i.y+10)+1&&(i.life=0))}},updateWind(){if(this.wind.gustTimer++,this.wind.gustTimer>120+Math.random()*180){this.wind.gustTimer=0;const t=.01+Math.random()*.04,i=Math.random()*Math.PI*2;this.wind.targetX=Math.cos(i)*t,this.wind.targetZ=Math.sin(i)*t}this.wind.x+=(this.wind.targetX-this.wind.x)*.02,this.wind.z+=(this.wind.targetZ-this.wind.z)*.02,this.wind.x+=(Math.random()-.5)*.002,this.wind.z+=(Math.random()-.5)*.002},updatePetals(){if(!this.cherryTrees||this.cherryTrees.length===0)return;const t=this.particles.filter(a=>a.type==="petal").length,i=150,e=Math.min(5,i-t);for(let a=0;a<e;a++){if(Math.random()>.6)continue;const s=this.cherryTrees[Math.floor(Math.random()*this.cherryTrees.length)],c=Math.sqrt((s.x-this.camera.x)**2+(s.z-this.camera.z)**2),f=40;if(c<f){const h=1-c/f*.5;if(Math.random()<h){const n=(Math.random()-.5)*10,d=(Math.random()-.5)*10,m=Math.random()<.3?Math.random()*8:0;this.particles.push({x:s.x+n,y:s.y+Math.random()*3+m,z:s.z+d,vx:this.wind.x*1.5+(Math.random()-.5)*.03,vy:-.008-Math.random()*.015,vz:this.wind.z*1.5+(Math.random()-.5)*.03,life:250+Math.random()*200,type:"petal",size:2.5+Math.random()*2.5,rotation:Math.random()*Math.PI*2,rotSpeed:(Math.random()-.5)*.15,flutter:Math.random()*Math.PI*2,flutterSpeed:.05+Math.random()*.05})}}}if(t<i*.8&&Math.random()<.3){const a=Math.random()*Math.PI*2,s=10+Math.random()*20;this.particles.push({x:this.camera.x+Math.cos(a)*s,y:this.camera.y+5+Math.random()*10,z:this.camera.z+Math.sin(a)*s,vx:this.wind.x*2+(Math.random()-.5)*.02,vy:-.005-Math.random()*.01,vz:this.wind.z*2+(Math.random()-.5)*.02,life:150+Math.random()*100,type:"petal",size:2+Math.random()*2,rotation:Math.random()*Math.PI*2,rotSpeed:(Math.random()-.5)*.12,flutter:Math.random()*Math.PI*2,flutterSpeed:.04+Math.random()*.04})}},dropItem(t,i,e,a,s){this.droppedItems||(this.droppedItems=[]),this.droppedItems.push({x:t+(Math.random()-.5)*.3,y:i,z:e+(Math.random()-.5)*.3,vy:.1+Math.random()*.05,type:a,count:s,bobPhase:Math.random()*Math.PI*2,pickupDelay:30})},updateDroppedItems(){if(this.droppedItems)for(let t=this.droppedItems.length-1;t>=0;t--){const i=this.droppedItems[t];i.pickupDelay>0&&i.pickupDelay--,i.vy-=.015,i.y+=i.vy;const e=this.getGroundHeightBelow(i.x,i.z,i.y+5)+1.3;if(i.y<e&&(i.y=e,i.vy=0),i.bobPhase+=.05,i.pickupDelay<=0){const a=i.x-this.camera.x,s=i.y-this.camera.y,c=i.z-this.camera.z;Math.sqrt(a*a+s*s+c*c)<2&&this.addToInventory(i.type,i.count)&&this.droppedItems.splice(t,1)}}},addToInventory(t,i){let e="block";(t==="ak47"||t==="berdger")&&(e="weapon"),(t==="water_bucket"||t==="lava_bucket")&&(e="bucket"),this.ritualItems&&this.ritualItems.includes(t)&&(e="item"),(t==="seeds"||t==="apple")&&(e="item"),this.showPickupNotification(t,i);for(let a=0;a<9;a++){const s=this.inventory.hotbar[a];if(s&&(s.id===t||s.type===t)&&s.count<64){const c=Math.min(i,64-s.count);if(s.count+=c,i-=c,i<=0)return this.updateHotbarDisplay(),!0}}for(let a=0;a<27;a++){const s=this.inventory.main[a];if(s&&(s.id===t||s.type===t)&&s.count<64){const c=Math.min(i,64-s.count);if(s.count+=c,i-=c,i<=0)return this.updateHotbarDisplay(),!0}}for(let a=0;a<9;a++)if(!this.inventory.hotbar[a]){const s=this.itemTypes[t]||{};return this.inventory.hotbar[a]={type:e,id:t,count:i,durability:s.durability,maxDurability:s.maxDurability},this.updateHotbarDisplay(),!0}for(let a=0;a<27;a++)if(!this.inventory.main[a]){const s=this.itemTypes[t]||{};return this.inventory.main[a]={type:e,id:t,count:i,durability:s.durability,maxDurability:s.maxDurability},this.updateHotbarDisplay(),!0}return!1},showPickupNotification(t,i){if(i<0){const e=document.getElementById("pickupNotification");if(!e)return;const a={grass:"Grass Block",dirt:"Dirt",stone:"Stone",wood:"Wood",appleLeaves:"Apple Leaves",leaves:"Leaves",sand:"Sand",brick:"Brick",ak47:"AK-47",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",obsidian:"Obsidian",cherryWood:"Cherry Wood",cherryLeaves:"Cherry Leaves",chest:"Chest",seeds:"Seeds",berdger:"The Berdger",apple:"Apple",sakuraPetal:"Cherry Petal",shimenawa:"Sacred Rope",omamori:"Charm",ema:"Wish Plaque",incense:"Incense",whiteBrick:"White Brick",redBrick:"Red Brick",glowstone:"Glowstone",ritualStone:"Ritual Stone"},s=document.createElement("div");s.className="pickup-item",s.style.borderColor="rgba(255, 50, 50, 0.8)",s.innerHTML=`
                        <span class="pickup-icon">üíî</span>
                        <span style="color:#ff6666">${a[t]||t} broke!</span>
                    `,e.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},2e3);return}this.queuePickupNotification(t,i)},drawMiniBlock(t,i){const e=t.getContext("2d"),a=this.blockColors[i],s=t.width,c=t.height;e.clearRect(0,0,s,c);const f=s/2,h=c/2,n=Math.min(s,c)*.35;if(!a){if(e.save(),e.translate(f,h),i==="apple")e.fillStyle="#dc143c",e.beginPath(),e.arc(0,0,n*.7,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255,255,255,0.3)",e.beginPath(),e.arc(-n*.2,-n*.2,n*.25,0,Math.PI*2),e.fill(),e.fillStyle="#654321",e.fillRect(-1,-n*.8,3,n*.3),e.fillStyle="#228b22",e.beginPath(),e.ellipse(3,-n*.7,4,2,.3,0,Math.PI*2),e.fill();else if(i==="seeds"){e.fillStyle="#daa520";for(let b=0;b<5;b++){const T=b/5*Math.PI*2,P=Math.cos(T)*n*.4,L=Math.sin(T)*n*.3;e.beginPath(),e.ellipse(P,L,3,5,T,0,Math.PI*2),e.fill()}}else i==="ak47"?(e.fillStyle="#333",e.fillRect(-n*.6,-n*.1,n*1.2,n*.25),e.fillStyle="#8b4513",e.fillRect(-n*.3,n*.1,n*.4,n*.4),e.fillStyle="#222",e.fillRect(n*.1,n*.1,n*.15,n*.35)):i==="berdger"?(e.fillStyle="#daa520",e.beginPath(),e.ellipse(0,-n*.3,n*.5,n*.25,0,0,Math.PI*2),e.fill(),e.fillStyle="#8b4513",e.fillRect(-n*.4,-n*.15,n*.8,n*.2),e.fillStyle="#228b22",e.fillRect(-n*.35,-n*.05,n*.7,n*.1),e.fillStyle="#daa520",e.beginPath(),e.ellipse(0,n*.2,n*.55,n*.3,0,0,Math.PI*2),e.fill()):i==="water_bucket"||i==="lava_bucket"?(e.fillStyle="#888",e.beginPath(),e.moveTo(-n*.4,-n*.3),e.lineTo(n*.4,-n*.3),e.lineTo(n*.3,n*.5),e.lineTo(-n*.3,n*.5),e.closePath(),e.fill(),e.fillStyle=i==="water_bucket"?"#4a90d9":"#ff6600",e.beginPath(),e.moveTo(-n*.3,-n*.1),e.lineTo(n*.3,-n*.1),e.lineTo(n*.25,n*.4),e.lineTo(-n*.25,n*.4),e.closePath(),e.fill()):i==="sakuraPetal"?(e.fillStyle="#ffb7c5",e.beginPath(),e.ellipse(0,0,n*.6,n*.3,.3,0,Math.PI*2),e.fill()):i==="shimenawa"?(e.strokeStyle="#daa520",e.lineWidth=4,e.beginPath(),e.moveTo(-n*.5,0),e.quadraticCurveTo(0,-n*.4,n*.5,0),e.stroke()):i==="omamori"?(e.fillStyle="#cc0000",e.fillRect(-n*.3,-n*.5,n*.6,n),e.fillStyle="#ffd700",e.fillRect(-n*.25,-n*.35,n*.5,n*.15)):i==="ema"?(e.fillStyle="#deb887",e.beginPath(),e.moveTo(0,-n*.5),e.lineTo(n*.4,-n*.2),e.lineTo(n*.4,n*.4),e.lineTo(-n*.4,n*.4),e.lineTo(-n*.4,-n*.2),e.closePath(),e.fill()):i==="incense"?(e.fillStyle="#8b4513",e.fillRect(-1,-n*.6,3,n*1.2),e.fillStyle="#ff6600",e.beginPath(),e.arc(.5,-n*.6,3,0,Math.PI*2),e.fill()):(e.fillStyle="#888",e.fillRect(-n*.4,-n*.4,n*.8,n*.8),e.fillStyle="#444",e.font="8px monospace",e.textAlign="center",e.fillText("?",0,3));e.restore();return}const d=Math.min(s,c)*.25;let m=a.top,u=a.side;typeof m=="string"&&m.includes("rgba")&&(m=m.replace(/[\d.]+\)$/,"1)"),u=u.replace(/[\d.]+\)$/,"1)")),e.fillStyle=m,e.beginPath(),e.moveTo(f,h-d),e.lineTo(f+d,h-d/2),e.lineTo(f,h),e.lineTo(f-d,h-d/2),e.closePath(),e.fill(),e.fillStyle=u,e.beginPath(),e.moveTo(f-d,h-d/2),e.lineTo(f,h),e.lineTo(f,h+d),e.lineTo(f-d,h+d/2),e.closePath(),e.fill();let y;try{y=this.darkenColor(u.replace(/rgba?\([^)]+\)/,"#888888"),.7)}catch{y=this.darkenColor(u,.7)}e.fillStyle=y,e.beginPath(),e.moveTo(f,h),e.lineTo(f+d,h-d/2),e.lineTo(f+d,h+d/2),e.lineTo(f,h+d),e.closePath(),e.fill(),e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=.5,e.beginPath(),e.moveTo(f,h-n),e.lineTo(f+n,h-n/2),e.lineTo(f+n,h+n/2),e.lineTo(f,h+n),e.lineTo(f-n,h+n/2),e.lineTo(f-n,h-n/2),e.closePath(),e.stroke()},drawDroppedItem3D(t,i,e,a,s,c){const f=this.blockColors[s],h=(c||0)*.5;if(t.save(),t.translate(i,e),!f){if(s==="apple")t.fillStyle="#dc143c",t.beginPath(),t.arc(0,0,a*.8,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255,255,255,0.3)",t.beginPath(),t.arc(-a*.2,-a*.2,a*.3,0,Math.PI*2),t.fill(),t.fillStyle="#654321",t.fillRect(-1,-a*.9,2,a*.3),t.fillStyle="#228b22",t.beginPath(),t.ellipse(2,-a*.8,3,2,.3,0,Math.PI*2),t.fill();else if(s==="seeds"){t.fillStyle="#daa520";for(let d=0;d<5;d++){const m=d/5*Math.PI*2+h,u=Math.cos(m)*a*.4,y=Math.sin(m)*a*.3;t.beginPath(),t.ellipse(u,y,a*.2,a*.1,m,0,Math.PI*2),t.fill()}}else s==="ak47"?(t.fillStyle="#333",t.fillRect(-a*.8,-a*.15,a*1.6,a*.3),t.fillRect(-a*.3,-a*.15,a*.15,a*.5),t.fillRect(a*.3,-a*.4,a*.5,a*.25)):s==="berdger"?(t.fillStyle="#D2691E",t.beginPath(),t.ellipse(0,-a*.2,a*.7,a*.35,0,Math.PI,0),t.fill(),t.fillStyle="#654321",t.fillRect(-a*.6,-a*.1,a*1.2,a*.25),t.fillStyle="#228B22",t.fillRect(-a*.55,a*.1,a*1.1,a*.1),t.fillStyle="#DEB887",t.beginPath(),t.ellipse(0,a*.25,a*.65,a*.3,0,0,Math.PI),t.fill()):s==="water_bucket"||s==="lava_bucket"?(t.fillStyle="#888",t.beginPath(),t.moveTo(-a*.5,-a*.5),t.lineTo(a*.5,-a*.5),t.lineTo(a*.4,a*.5),t.lineTo(-a*.4,a*.5),t.closePath(),t.fill(),t.fillStyle=s==="water_bucket"?"#4a90d9":"#ff6600",t.fillRect(-a*.35,-a*.3,a*.7,a*.6),t.strokeStyle="#666",t.lineWidth=2,t.beginPath(),t.arc(0,-a*.6,a*.4,Math.PI*.2,Math.PI*.8),t.stroke()):s==="sakuraPetal"?(t.fillStyle="#ffb7c5",t.beginPath(),t.ellipse(0,0,a*.6,a*.3,h,0,Math.PI*2),t.fill()):s==="shimenawa"?(t.strokeStyle="#daa520",t.lineWidth=a*.2,t.beginPath(),t.moveTo(-a*.6,0),t.bezierCurveTo(-a*.3,-a*.4,a*.3,a*.4,a*.6,0),t.stroke()):s==="omamori"?(t.fillStyle="#ff4444",t.fillRect(-a*.3,-a*.5,a*.6,a*.8),t.fillStyle="#gold",t.fillRect(-a*.2,-a*.4,a*.4,a*.15)):s==="ema"?(t.fillStyle="#deb887",t.beginPath(),t.moveTo(0,-a*.6),t.lineTo(a*.5,-a*.2),t.lineTo(a*.5,a*.5),t.lineTo(-a*.5,a*.5),t.lineTo(-a*.5,-a*.2),t.closePath(),t.fill()):s==="incense"?(t.fillStyle="#8b4513",t.fillRect(-1,-a*.6,2,a*1.2),t.fillStyle="#ff6600",t.beginPath(),t.arc(0,-a*.6,3,0,Math.PI*2),t.fill()):(t.fillStyle="#888",t.fillRect(-a*.5,-a*.5,a,a));t.restore();return}const n=a*.8;t.fillStyle=f.top,t.beginPath(),t.moveTo(0,-n),t.lineTo(n,-n/2),t.lineTo(0,0),t.lineTo(-n,-n/2),t.closePath(),t.fill(),t.fillStyle=f.side,t.beginPath(),t.moveTo(-n,-n/2),t.lineTo(0,0),t.lineTo(0,n),t.lineTo(-n,n/2),t.closePath(),t.fill(),t.fillStyle=this.darkenColor(f.side,.7),t.beginPath(),t.moveTo(0,0),t.lineTo(n,-n/2),t.lineTo(n,n/2),t.lineTo(0,n),t.closePath(),t.fill(),t.strokeStyle="rgba(0,0,0,0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(0,-n),t.lineTo(n,-n/2),t.lineTo(n,n/2),t.lineTo(0,n),t.lineTo(-n,n/2),t.lineTo(-n,-n/2),t.closePath(),t.stroke(),t.restore()},useSeeds(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&t.id==="seeds"&&t.count>0){t.count--,t.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbarDisplay(),this.seedCalmTimer=600;for(let i=0;i<10;i++)this.particles.push({x:this.camera.x+(Math.random()-.5)*2,y:this.camera.y-.5,z:this.camera.z+(Math.random()-.5)*2,vx:(Math.random()-.5)*.2,vy:.1+Math.random()*.1,vz:(Math.random()-.5)*.2,life:60,type:"spark",size:2});return!0}return!1},shootBerdger(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&t.id==="berdger"){const i=this.camera.rotX,e=this.camera.rotY,a=Math.cos(i),s=Math.sin(i),c=-Math.sin(e)*a,f=-s,h=Math.cos(e)*a;return this.particles.push({x:this.camera.x+c*.5,y:this.camera.y+f*.5,z:this.camera.z+h*.5,vx:c*.8,vy:f*.8,vz:h*.8,life:120,type:"burger",size:8,trail:[]}),!0}return!1},throwApple(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&t.id==="apple"&&t.count>0){t.count--,t.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbarDisplay();const i=this.camera.rotX,e=this.camera.rotY,a=Math.cos(i),s=Math.sin(i),c=-Math.sin(e)*a,f=-s,h=Math.cos(e)*a;return this.particles.push({x:this.camera.x+c*.5,y:this.camera.y+f*.5,z:this.camera.z+h*.5,vx:c*.6,vy:f*.6+.1,vz:h*.6,life:180,type:"apple",size:6,gravity:-.008}),!0}return!1},checkRitual(){if(this.ritualComplete)return;const t={};for(const e of this.ritualItems)t[e]=!1;for(let e=0;e<9;e++){const a=this.inventory.hotbar[e];a&&this.ritualItems.includes(a.id)&&(t[a.id]=!0)}if(this.ritualItems.every(e=>t[e])){this.ritualComplete=!0,this.ritualBlessingActive=!0,this.ritualBlessingTimer=36e3;for(let e=0;e<9;e++){const a=this.inventory.hotbar[e];a&&this.ritualItems.includes(a.id)&&(this.inventory.hotbar[e]=null)}this.updateHotbarDisplay();for(const e of this.pestBirds)e.anger=0,e.state="circling";for(let e=0;e<50;e++)this.particles.push({x:this.camera.x+(Math.random()-.5)*8,y:this.camera.y+Math.random()*5,z:this.camera.z+(Math.random()-.5)*8,vx:(Math.random()-.5)*.1,vy:.05+Math.random()*.1,vz:(Math.random()-.5)*.1,life:120+Math.random()*60,type:"petal",size:4+Math.random()*3,rotation:Math.random()*Math.PI*2,rotSpeed:(Math.random()-.5)*.2,flutter:Math.random()*Math.PI*2});return!0}return!1},interactWithSocket(t,i,e,a){const s={petalSocket:"sakuraPetal",ropeSocket:"shimenawa",charmSocket:"omamori",plaqueSocket:"ema",incenseSocket:"incense"},c={petalSocket:"petalSocketFilled",ropeSocket:"ropeSocketFilled",charmSocket:"charmSocketFilled",plaqueSocket:"plaqueSocketFilled",incenseSocket:"incenseSocketFilled"},f=s[a];if(!f||a.includes("Filled"))return;const h=this.inventory.hotbar[this.selectedSlot];if(h&&h.id===f&&h.count>0){h.count--,h.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null),this.updateHotbarDisplay(),this.setBlock(t,i,e,c[a]),this.socketsFilled||(this.socketsFilled={}),this.socketsFilled[a]=!0;for(let d=0;d<20;d++)this.particles.push({x:t+.5+(Math.random()-.5)*.5,y:i+1+Math.random()*.5,z:e+.5+(Math.random()-.5)*.5,vx:(Math.random()-.5)*.1,vy:.1+Math.random()*.1,vz:(Math.random()-.5)*.1,life:60+Math.random()*40,type:"spark",size:3+Math.random()*2});if(Object.keys(s).every(d=>this.socketsFilled&&this.socketsFilled[d])&&!this.ritualComplete){if(this.ritualComplete=!0,this.ritualBlessingActive=!0,this.ritualBlessingTimer=60*60*10,this.triggerRitualReward(),this.pestBirds)for(const d of this.pestBirds)d.anger=0,d.state="fleeing",d.stateTimer=600;this.survivalStats&&(this.survivalStats.score+=5e3,this.survivalStats.currentObjective={text:"Blessing active - birds flee!",type:"complete"},this.updateSurvivalHUD());for(let d=0;d<100;d++)this.particles.push({x:t+.5+(Math.random()-.5)*10,y:i+Math.random()*8,z:e+.5+(Math.random()-.5)*10,vx:(Math.random()-.5)*.15,vy:.1+Math.random()*.15,vz:(Math.random()-.5)*.15,life:180+Math.random()*120,type:"petal",size:4+Math.random()*4,rotation:Math.random()*Math.PI*2,rotSpeed:(Math.random()-.5)*.2,flutter:Math.random()*Math.PI*2})}}},openChest(t,i,e){this.chestContents||(this.chestContents={});const a=`${t},${i},${e}`,s=this.chestContents[a];if(s&&Array.isArray(s)&&s.length>0){for(const c of s){if(!c)continue;const f=c.type||c.id,h=c.count||1;f&&(this.addToInventory(f,h)||this.dropItem(t+.5,i+1.5,e+.5,f,h))}this.chestContents[a]=[],this.updateHotbarDisplay()}},dropHeldItem(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&t.count>0){const i=-Math.sin(this.camera.rotY),e=Math.cos(this.camera.rotY),a=t.id||t.type;this.dropItem(this.camera.x+i*1.5,this.camera.y,this.camera.z+e*1.5,a,1),t.count--,t.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbarDisplay()}},debugConsoleOpen:!1,debugNoclip:!1,debugGodMode:!1,debugShowCoords:!1,debugFly:!1,debugMoveSpeed:null,toggleDebugConsole(){this.debugConsoleOpen=!this.debugConsoleOpen;const t=document.getElementById("debugConsole");if(t&&(t.classList.toggle("active",this.debugConsoleOpen),this.debugConsoleOpen)){const i=document.getElementById("debugInput");i&&setTimeout(()=>i.focus(),50),this.debugLog('Debug console opened. Type "help" for commands.',"info")}},setupDebugConsole(){const t=document.getElementById("debugInput");t&&(t.addEventListener("keydown",i=>{if(i.key==="Enter"){const e=t.value.trim();e&&(this.executeDebugCommand(e),t.value="")}(i.key==="`"||i.key==="~")&&(i.preventDefault(),this.toggleDebugConsole()),i.stopPropagation()}),t.addEventListener("keyup",i=>i.stopPropagation()))},debugLog(t,i="normal"){const e=document.getElementById("debugOutput");if(e){const a=document.createElement("div");for(a.className=i,a.textContent=`> ${t}`,e.appendChild(a),e.scrollTop=e.scrollHeight;e.children.length>100;)e.removeChild(e.firstChild)}},executeDebugCommand(t){const i=t.toLowerCase().split(" "),e=i[0],a=i.slice(1);switch(this.debugLog(t,"normal"),e){case"help":this.debugLog("Commands:","info"),this.debugLog("  noclip - Toggle flying through walls","info"),this.debugLog("  god - Toggle invincibility","info"),this.debugLog("  coords - Toggle coordinate display","info"),this.debugLog("  tp <x> <y> <z> - Teleport to position","info"),this.debugLog("  give <item> [count] - Give item","info"),this.debugLog("  spawn <mob> [count] - Spawn mobs","info"),this.debugLog("    mobs: bird, fish, cat, creeper, bluebird","info"),this.debugLog("  time <ms> - Set bird event timer","info"),this.debugLog("  kill - Kill all mobs","info"),this.debugLog("  clear - Clear console","info"),this.debugLog("  pos - Show current position","info"),this.debugLog("  fly - Toggle flight mode","info"),this.debugLog("  speed <value> - Set move speed","info"),this.debugLog("  ritual - Complete ritual instantly","info"),this.debugLog("  score <value> - Set score","info"),this.debugLog("  temple - Teleport to ritual temple","info");break;case"noclip":this.debugNoclip=!this.debugNoclip,this.debugLog(`Noclip: ${this.debugNoclip?"ON":"OFF"}`,this.debugNoclip?"success":"warn");break;case"god":this.debugGodMode=!this.debugGodMode,this.debugLog(`God mode: ${this.debugGodMode?"ON":"OFF"}`,this.debugGodMode?"success":"warn");break;case"coords":this.debugShowCoords=!this.debugShowCoords,this.debugLog(`Coords display: ${this.debugShowCoords?"ON":"OFF"}`,"success");break;case"fly":this.debugFly=!this.debugFly,this.debugLog(`Fly mode: ${this.debugFly?"ON":"OFF"}`,this.debugFly?"success":"warn");break;case"tp":if(a.length>=3){const d=parseFloat(a[0]),m=parseFloat(a[1]),u=parseFloat(a[2]);!isNaN(d)&&!isNaN(m)&&!isNaN(u)?(this.camera.x=d,this.camera.y=m,this.camera.z=u,this.velocity={x:0,y:0,z:0},this.debugLog(`Teleported to ${d.toFixed(1)}, ${m.toFixed(1)}, ${u.toFixed(1)}`,"success")):this.debugLog("Invalid coordinates","error")}else this.debugLog("Usage: tp <x> <y> <z>","error");break;case"temple":this.ritualTempleLocation?(this.camera.x=this.ritualTempleLocation.x+5,this.camera.y=this.ritualTempleLocation.y+3,this.camera.z=this.ritualTempleLocation.z+5,this.velocity={x:0,y:0,z:0},this.debugLog("Teleported to Ritual Temple","success")):this.debugLog("Temple not found","error");break;case"pos":this.debugLog(`Position: ${this.camera.x.toFixed(2)}, ${this.camera.y.toFixed(2)}, ${this.camera.z.toFixed(2)}`,"info"),this.debugLog(`Rotation: ${(this.camera.rotX*180/Math.PI).toFixed(1)}¬∞, ${(this.camera.rotY*180/Math.PI).toFixed(1)}¬∞`,"info");break;case"give":if(a.length>=1){const d=a[0],m=a.length>=2?parseInt(a[1]):1;this.blockColors[d]||this.itemTypes[d]?(this.addToInventory(d,m),this.debugLog(`Given ${m}x ${d}`,"success")):(this.debugLog(`Unknown item: ${d}`,"error"),this.debugLog("Items: "+Object.keys(this.itemTypes).slice(0,10).join(", ")+"...","info"))}else this.debugLog("Usage: give <item> [count]","error");break;case"spawn":const s=a[0],c=a.length>=2?parseInt(a[1]):1,f=["bird","pest","fish","cat","creeper","bluebird"];if(s==="bird"||s==="pest"){for(let d=0;d<c;d++)this.spawnPestBird();this.debugLog(`Spawned ${c} pest bird(s)`,"success")}else if(s==="fish"){for(let d=0;d<c;d++)this.spawnFish();this.debugLog(`Spawned ${c} fish`,"success")}else if(s==="cat"){for(let d=0;d<c;d++)this.spawnCat();this.debugLog(`Spawned ${c} cat(s)`,"success")}else if(s==="creeper"){for(let d=0;d<c;d++)this.spawnCreeper();this.debugLog(`Spawned ${c} creeper(s)`,"success")}else if(s==="bluebird"){for(let d=0;d<c;d++)this.spawnBlueBird();this.debugLog(`Spawned ${c} blue bird(s)`,"success")}else this.debugLog("Usage: spawn <mob> [count]","error"),this.debugLog("Mobs: "+f.join(", "),"info");break;case"kill":let h=0;h+=this.pestBirds?this.pestBirds.length:0,h+=this.blueBirds?this.blueBirds.length:0,h+=this.creepers?this.creepers.length:0,this.pestBirds=[],this.blueBirds=[],this.creepers=[],this.debugLog(`Killed ${h} mobs`,"success");break;case"time":if(a.length>=1){const d=parseInt(a[0]);!isNaN(d)&&this.birdEvent&&(this.birdEvent.timer=d,this.debugLog(`Bird event timer set to ${d}ms`,"success"))}else this.debugLog("Usage: time <ms>","error");break;case"clear":const n=document.getElementById("debugOutput");n&&(n.innerHTML="");break;case"speed":a.length>=1?(this.debugMoveSpeed=parseFloat(a[0]),this.debugLog(`Speed set to ${this.debugMoveSpeed}`,"success")):this.debugLog("Usage: speed <value> (default: 0.12)","error");break;case"ritual":this.ritualComplete=!0,this.ritualBlessingActive=!0,this.ritualBlessingTimer=60*60*10,this.socketsFilled={petalSocket:!0,ropeSocket:!0,charmSocket:!0,plaqueSocket:!0,incenseSocket:!0},this.triggerRitualReward(),this.debugLog("Ritual completed!","success");break;case"score":a.length>=1&&this.survivalStats&&(this.survivalStats.score=parseInt(a[0]),this.updateSurvivalHUD(),this.debugLog(`Score set to ${this.survivalStats.score}`,"success"));break;default:this.debugLog(`Unknown command: ${e}`,"error")}},triggerRitualReward(){this.birdEvent&&this.showBirdAlert("üå∏ DIVINE BLESSING ACTIVATED! üå∏"),this.ritualFlight=!0,this.ritualFlightTimer=60*60*2,this.ritualBarrierActive=!0,this.addToInventory("berdger",1),this.addToInventory("apple",32),this.survivalStats&&(this.survivalStats.score+=1e4,this.survivalStats.wave++,this.survivalStats.currentObjective={text:"‚ú® Divine protection active!",type:"blessed"},this.updateSurvivalHUD());for(const t of this.pestBirds)t.state="fleeing",t.stateTimer=1200,t.anger=0;for(let t=0;t<100;t++)this.particles.push({x:this.camera.x+(Math.random()-.5)*10,y:this.camera.y+Math.random()*8-2,z:this.camera.z+(Math.random()-.5)*10,vx:(Math.random()-.5)*.15,vy:.1+Math.random()*.2,vz:(Math.random()-.5)*.15,life:200+Math.random()*100,type:"blessing",size:4+Math.random()*4})},pickupQueue:{},pickupTimer:null,queuePickupNotification(t,i){this.pickupQueue[t]||(this.pickupQueue[t]=0),this.pickupQueue[t]+=i,this.pickupTimer&&clearTimeout(this.pickupTimer),this.pickupTimer=setTimeout(()=>{this.flushPickupNotifications()},500)},flushPickupNotifications(){const t=document.getElementById("pickupNotification");if(!t)return;const i={grass:"Grass Block",dirt:"Dirt",stone:"Stone",wood:"Wood",appleLeaves:"Apple Leaves",leaves:"Leaves",sand:"Sand",brick:"Brick",ak47:"AK-47",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",obsidian:"Obsidian",cherryWood:"Cherry Wood",cherryLeaves:"Cherry Leaves",chest:"Chest",seeds:"Seeds",berdger:"The Berdger",apple:"Apple",sakuraPetal:"Cherry Petal",shimenawa:"Sacred Rope",omamori:"Charm",ema:"Wish Plaque",incense:"Incense",whiteBrick:"White Brick",redBrick:"Red Brick",glowstone:"Glowstone",ritualStone:"Ritual Stone"};for(const[e,a]of Object.entries(this.pickupQueue)){if(a===0)continue;const s=document.createElement("div");s.className="pickup-item";const c=document.createElement("canvas");c.width=24,c.height=24,this.drawMiniBlock(c,e),s.innerHTML=`
                        <span class="pickup-icon"></span>
                        <span>+${a} ${i[e]||e}</span>
                    `,s.querySelector(".pickup-icon").appendChild(c),t.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},2e3)}this.pickupQueue={},this.pickupTimer=null},setFluidLevel(t,i,e,a){const s=`${t},${i},${e}`;a<=0?delete this.fluidLevels[s]:this.fluidLevels[s]=Math.min(8,Math.max(1,a))},getFluidLevel(t,i,e){return this.fluidLevels[`${t},${i},${e}`]||0},updateFluids(){if(this.fluidUpdateTimer||(this.fluidUpdateTimer=0),this.fluidUpdateTimer++,this.fluidUpdateTimer<8)return;this.fluidUpdateTimer=0;const t=2;let i=0;for(;this.fluidUpdates.length>0&&i<t;){const e=this.fluidUpdates.shift();i++;const a=this.getBlock(e.x,e.y,e.z);if(!a||!this.fluidBlocks.includes(a)){this.setFluidLevel(e.x,e.y,e.z,0);continue}const s=e.level||8,c=this.getBlock(e.x,e.y-1,e.z);if(c==="water"&&e.type==="lava"){this.setBlock(e.x,e.y-1,e.z,"stone"),this.setFluidLevel(e.x,e.y-1,e.z,0);continue}else if(c==="lava"&&e.type==="water"){this.setBlock(e.x,e.y-1,e.z,"obsidian"),this.setFluidLevel(e.x,e.y-1,e.z,0);continue}if(!c){this.setBlock(e.x,e.y-1,e.z,e.type),this.setFluidLevel(e.x,e.y-1,e.z,8),this.fluidUpdates.push({x:e.x,y:e.y-1,z:e.z,type:e.type,level:8});continue}const f=s-1;if(!(f<=0)&&c&&!this.fluidBlocks.includes(c)){const h=[{x:1,z:0},{x:-1,z:0},{x:0,z:1},{x:0,z:-1}];for(let n=h.length-1;n>0;n--){const d=Math.floor(Math.random()*(n+1));[h[n],h[d]]=[h[d],h[n]]}for(const n of h){const d=e.x+n.x,m=e.z+n.z,u=this.getBlock(d,e.y,m),y=this.getFluidLevel(d,e.y,m);if(e.type==="lava"&&u==="water"){this.setBlock(d,e.y,m,"stone"),this.setFluidLevel(d,e.y,m,0);continue}else if(e.type==="water"&&u==="lava"){this.setBlock(d,e.y,m,"stone"),this.setFluidLevel(d,e.y,m,0);continue}u?u===e.type&&y<f&&(this.setFluidLevel(d,e.y,m,f),this.fluidUpdates.push({x:d,y:e.y,z:m,type:e.type,level:f})):(this.setBlock(d,e.y,m,e.type),this.setFluidLevel(d,e.y,m,f),this.fluidUpdates.push({x:d,y:e.y,z:m,type:e.type,level:f}))}}}},toggleInventory(){this.inventoryOpen=!this.inventoryOpen;const t=document.getElementById("inventoryScreen");t&&t.classList.toggle("active",this.inventoryOpen),this.inventoryOpen?(this.inventoryHeldItem=null,this.renderInventory(),document.pointerLockElement&&document.exitPointerLock()):(this.inventoryHeldItem=null,this.justClosedInventory=!0,setTimeout(()=>{this.justClosedInventory=!1},100),this.isPaused||this.canvas.requestPointerLock())},renderInventory(){const t=document.getElementById("inventoryScreen");if(!t)return;const i=a=>{if(!a)return"";const s=a.id||a.type;return{grass:"Grass Block",dirt:"Dirt",stone:"Stone",wood:"Wood",leaves:"Leaves",water:"Water",sand:"Sand",brick:"Brick",ak47:"AK-47",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",lava:"Lava",obsidian:"Obsidian",cherryWood:"Cherry Wood",cherryLeaves:"Cherry Leaves",chest:"Chest",ritualChest:"Ritual Chest",buildingChest:"Building Chest",seeds:"Seeds",berdger:"The Berdger",sakuraPetal:"Sacred Cherry Petal",shimenawa:"Sacred Rope",omamori:"Protective Charm",ema:"Wooden Wish Plaque",incense:"Purifying Incense"}[s]||s};let e='<div class="inventory-container">';e+="<h2>Inventory</h2>",e+='<div class="crafting-section">',e+="<h3>Crafting</h3>",e+='<div class="recipe-list">';for(const a of this.recipes){const s=this.canCraftRecipe(a);e+=`<div class="recipe ${s?"craftable":"disabled"}" data-recipe="${a.name}">`,e+=`<span class="recipe-name">${a.name}</span>`,e+='<span class="recipe-ingredients">',a.ingredients.forEach(c=>{e+=`${c.count}x ${c.id} `}),e+="</span>",e+=`<span class="recipe-result">‚Üí ${a.result.count}x ${a.result.id}</span>`,s&&(e+=`<button class="craft-btn" onclick="minecraftGame.craftRecipe('${a.name}')">Craft</button>`),e+="</div>"}e+="</div></div>",e+='<div class="inv-hotbar">',e+="<h3>Hotbar</h3>",e+='<div class="inv-slots" id="hotbarSlots">',this.inventory.hotbar.forEach((a,s)=>{const c=this.getItemEmoji(a),f=a&&a.count>0,h=this.inventoryHeldItem&&this.inventoryHeldItem.source==="hotbar"&&this.inventoryHeldItem.index===s,n=f?i(a):"";e+=`<div class="inv-slot ${s===this.selectedSlot?"selected":""} ${f?"has-item":""} ${h?"held":""}" 
                        data-source="hotbar" data-index="${s}" ${n?`data-tooltip="${n}"`:""}
                        draggable="${f}">${c}<span class="count">${a?a.count:""}</span></div>`}),e+="</div></div>",e+='<div class="inv-main">',e+="<h3>Storage</h3>",e+='<div class="inv-slots" id="storageSlots">';for(let a=0;a<27;a++){const s=this.inventory.main[a];s&&s.count>0;const c=this.inventoryHeldItem&&this.inventoryHeldItem.source==="main"&&this.inventoryHeldItem.index===a;if(s){const f=this.getItemEmoji(s),h=i(s);e+=`<div class="inv-slot has-item ${c?"held":""}" data-source="main" data-index="${a}" ${h?`data-tooltip="${h}"`:""} draggable="true">${f}<span class="count">${s.count}</span></div>`}else e+=`<div class="inv-slot empty" data-source="main" data-index="${a}" draggable="false"></div>`}e+="</div></div>",e+='<p class="inv-hint">Click items to pick up/place | Drag also works | Press E or ESC to close</p>',e+="</div>",t.innerHTML=e,this.setupInventoryDragDrop()},setupInventoryDragDrop(){const t=document.getElementById("inventoryScreen"),i=document.querySelectorAll("#inventoryScreen .inv-slot");this.inventoryHeldItem||(this.inventoryHeldItem=null);const e=t.querySelector(".inventory-container");e&&e.addEventListener("wheel",a=>{a.stopPropagation();const{scrollTop:s,scrollHeight:c,clientHeight:f}=e,h=s===0,n=s+f>=c;(h&&a.deltaY<0||n&&a.deltaY>0)&&a.preventDefault()},{passive:!1}),t.addEventListener("dragover",a=>{a.preventDefault(),a.stopPropagation()}),t.addEventListener("drop",a=>{a.preventDefault(),a.stopPropagation()}),i.forEach(a=>{a.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();const c=a.dataset.source,f=parseInt(a.dataset.index),n=(c==="hotbar"?this.inventory.hotbar:this.inventory.main)[f];this.inventoryHeldItem?(this.swapInventorySlots(this.inventoryHeldItem.source,this.inventoryHeldItem.index,c,f),this.inventoryHeldItem=null,this.renderInventory(),this.updateHotbar(),this.updateHotbarDisplay()):n&&n.count>0&&(this.inventoryHeldItem={source:c,index:f},this.renderInventory())}),a.addEventListener("dragstart",s=>{s.stopPropagation();const c=a.dataset.source,f=parseInt(a.dataset.index);this.draggedItem={source:c,index:f},a.classList.add("dragging"),s.dataTransfer.effectAllowed="move",s.dataTransfer.setDragImage(a,20,20)}),a.addEventListener("dragend",s=>{s.preventDefault(),s.stopPropagation(),a.classList.remove("dragging"),this.draggedItem=null}),a.addEventListener("dragover",s=>{s.preventDefault(),s.stopPropagation(),s.dataTransfer.dropEffect="move",a.classList.add("drag-over")}),a.addEventListener("dragleave",s=>{s.preventDefault(),s.stopPropagation(),a.classList.remove("drag-over")}),a.addEventListener("drop",s=>{if(s.preventDefault(),s.stopPropagation(),a.classList.remove("drag-over"),!this.draggedItem)return;const c=a.dataset.source,f=parseInt(a.dataset.index),h=document.querySelector(".inventory-container"),n=h?h.scrollTop:0;this.swapInventorySlots(this.draggedItem.source,this.draggedItem.index,c,f),this.draggedItem=null,this.renderInventory(),this.updateHotbar(),this.updateHotbarDisplay();const d=document.querySelector(".inventory-container");d&&(d.scrollTop=n)})})},swapInventorySlots(t,i,e,a){const s=t==="hotbar"?this.inventory.hotbar:this.inventory.main,c=e==="hotbar"?this.inventory.hotbar:this.inventory.main,f=s[i],h=c[a];if(s[i]=h,c[a]=f,t==="hotbar"||e==="hotbar"){const n=this.inventory.hotbar[this.selectedSlot];n?n.type==="block"?(this.selectedBlock=n.id,this.selectedItem=null):n.type==="weapon"&&(this.selectedItem=n.id,this.selectedBlock=null):(this.selectedBlock=null,this.selectedItem=null)}},getItemEmoji(t){if(!t)return"";const i=t.id||t.type;return{grass:"üåø",dirt:"üü´",stone:"ü™®",wood:"ü™µ",leaves:"üå∏",water:"üíß",sand:"üèñÔ∏è",brick:"üß±",ak47:"üî´",water_bucket:"ü™£",lava_bucket:"ü´ß",lava:"üî•",obsidian:"üü£",cherryWood:"ü™µ",cherryLeaves:"üå∏",chest:"üì¶",ritualChest:"üì¶",buildingChest:"üì¶",seeds:"üåæ",berdger:"üçî",sakuraPetal:"üå∏",shimenawa:"ü™¢",omamori:"üéÄ",ema:"ü™ß",incense:"üïØÔ∏è"}[i]||"‚ùì"},canCraftRecipe(t){for(const i of t.ingredients)if(this.countItem(i.id)<i.count)return!1;return!0},countItem(t){let i=0;for(const e of this.inventory.hotbar)e&&e.id===t&&(i+=e.count);for(const e of this.inventory.main)e&&e.id===t&&(i+=e.count);return i},craftRecipe(t){const i=this.recipes.find(e=>e.name===t);if(!(!i||!this.canCraftRecipe(i))){for(const e of i.ingredients)this.removeItem(e.id,e.count);this.addItem(i.result),this.renderInventory()}},removeItem(t,i){let e=i;for(const a of this.inventory.hotbar)if(a&&a.id===t&&e>0){const s=Math.min(a.count,e);a.count-=s,e-=s}for(const a of this.inventory.main)if(a&&a.id===t&&e>0){const s=Math.min(a.count,e);a.count-=s,e-=s}},addItem(t){for(const i of this.inventory.hotbar)if(i&&i.id===t.id&&i.count<64){const e=Math.min(64-i.count,t.count);if(i.count+=e,t.count-=e,t.count<=0)return}for(const i of this.inventory.main)if(i&&i.id===t.id&&i.count<64){const e=Math.min(64-i.count,t.count);if(i.count+=e,t.count-=e,t.count<=0)return}for(let i=0;i<this.inventory.main.length;i++)if(!this.inventory.main[i]){this.inventory.main[i]={...t};return}},raycast(){const t=this.camera.rotX,i=this.camera.rotY,e=Math.cos(t),a=Math.sin(t),s=Math.cos(i),f=-Math.sin(i)*e,h=-a,n=s*e,d=Math.sqrt(f*f+h*h+n*n),m=f/d,u=h/d,y=n/d,b=.1;let T=this.camera.x+m*b,P=this.camera.y+u*b,L=this.camera.z+y*b,z=Math.floor(T),R=Math.floor(P),I=Math.floor(L);const E=m>=0?1:-1,H=u>=0?1:-1,D=y>=0?1:-1,Q=Math.abs(1/m),U=Math.abs(1/u),X=Math.abs(1/y);let Z,Y,q;m>0?Z=(z+1-T)/m:m<0?Z=(z-T)/m:Z=1/0,u>0?Y=(R+1-P)/u:u<0?Y=(R-P)/u:Y=1/0,y>0?q=(I+1-L)/y:y<0?q=(I-L)/y:q=1/0;let o=null;const r=6;let l=0,p=null,g=!1,k=!1;for(let v=0;v<100;v++){const M=this.getBlock(z,R,I);if(M)if(M==="water"||M==="lava")M==="water"&&(g=!0),M==="lava"&&(k=!0);else{let w=null;const S=p||o;return S&&(w={x:z+S.x,y:R+S.y,z:I+S.z}),{hit:{x:z,y:R,z:I},place:w,block:M,throughWater:g,throughLava:k}}else p=o;if(Z<Y&&Z<q){if(l=Z,l>r)break;z+=E,Z+=Q,o={x:-E,y:0,z:0}}else if(Y<q){if(l=Y,l>r)break;R+=H,Y+=U,o={x:0,y:-H,z:0}}else{if(l=q,l>r)break;I+=D,q+=X,o={x:0,y:0,z:-D}}}return null},update(){if(!this.isActive||this.isPaused)return;this.shootCooldown>0&&this.shootCooldown--,this.muzzleFlash>0&&this.muzzleFlash--,this.ritualFlightTimer>0&&(this.ritualFlightTimer--,this.ritualFlightTimer<=0&&(this.ritualFlight=!1));const t=this.debugMoveSpeed||.12,e=this.debugNoclip||this.debugFly||this.ritualFlight?t*2:t,a=Math.sin(this.camera.rotY),s=Math.cos(this.camera.rotY);if(this.debugNoclip||this.debugFly){let B=0,x=0,F=0;this.keys.w&&(B-=a*Math.cos(this.camera.rotX)*e,x-=Math.sin(this.camera.rotX)*e,F+=s*Math.cos(this.camera.rotX)*e),this.keys.s&&(B+=a*Math.cos(this.camera.rotX)*e,x+=Math.sin(this.camera.rotX)*e,F-=s*Math.cos(this.camera.rotX)*e),this.keys.a&&(B-=s*e,F-=a*e),this.keys.d&&(B+=s*e,F+=a*e),this.keys[" "]&&(x+=e),this.keys.shift&&(x-=e),this.debugNoclip?(this.camera.x+=B,this.camera.y+=x,this.camera.z+=F):(this.camera.x+=B,this.camera.y+=x,this.camera.z+=F),this.velocity={x:0,y:0,z:0};return}if(this.ritualFlight){let B=0,x=0,F=0;this.keys.w&&(B-=a*e,F+=s*e),this.keys.s&&(B+=a*e,F-=s*e),this.keys.a&&(B-=s*e,F-=a*e),this.keys.d&&(B+=s*e,F+=a*e),this.keys[" "]&&(x+=e),this.keys.shift&&(x-=e);const $=this.camera.x+B,A=this.camera.y+x,O=this.camera.z+F,W=Math.floor(A-this.playerEyeHeight),K=Math.floor(A),V=Math.floor($),it=Math.floor(O);let tt=!0;for(let N=W;N<=K;N++){const et=this.getBlock(V,N,it);if(et&&!this.fluidBlocks.includes(et)){tt=!1;break}}tt&&(this.camera.x=$,this.camera.y=A,this.camera.z=O),this.velocity={x:0,y:0,z:0};return}const c=this.camera.y-this.playerEyeHeight,f=c+this.playerHeight,h=Math.floor(this.camera.x),n=Math.floor(this.camera.z),d=this.getBlock(h,Math.floor(c),n),m=this.getBlock(h,Math.floor(c+.9),n),u=this.getBlock(h,Math.floor(f-.1),n),y=d==="water",b=d==="lava",T=m==="water",P=m==="lava",L=u==="water",z=u==="lava",R=y||T,I=b||P,E=R||I,H=L||z;this.inWater=R||L,this.inLava=I||z,this.swimming=E,this.headSubmergedWater=L,this.headSubmergedLava=z;let D=1;R&&(D=.65),I&&(D=.35);let Q=0,U=0;const X=t;this.keys.w&&(Q-=a*X*D,U+=s*X*D),this.keys.s&&(Q+=a*X*D,U-=s*X*D),this.keys.a&&(Q-=s*X*D,U-=a*X*D),this.keys.d&&(Q+=s*X*D,U+=a*X*D);const Z=this.camera.x,Y=this.camera.z,q=.25,o=1.8;if(this.collidesAt(this.camera.x,this.camera.y,this.camera.z,q,o)){let B=!1;for(let x=.1;x<=1.5&&!B;x+=.1){const F=[0,45,90,135,180,225,270,315];for(const $ of F){const A=$*Math.PI/180,O=this.camera.x+Math.cos(A)*x,W=this.camera.z+Math.sin(A)*x;if(!this.collidesAt(O,this.camera.y,W,q,o)){this.camera.x=O,this.camera.z=W,B=!0;break}}!B&&!this.collidesAt(this.camera.x,this.camera.y+x,this.camera.z,q,o)&&(this.camera.y+=x,B=!0)}}let r=this.camera.x,l=this.camera.z;const p=8,g=Q/p,k=U/p;for(let B=0;B<p;B++){const x=r+g;if(!this.collidesAt(x,this.camera.y,l,q,o))r=x;else{const $=g*.5;this.collidesAt(r+$,this.camera.y,l,q,o)||(r+=$)}const F=l+k;if(!this.collidesAt(r,this.camera.y,F,q,o))l=F;else{const $=k*.5;this.collidesAt(r,this.camera.y,l+$,q,o)||(l+=$)}}this.collidesAt(r,this.camera.y,l,q,o)&&(r=this.camera.x,l=this.camera.z),this.camera.x=r,this.camera.z=l;const v=this.camera.x-Z,M=this.camera.z-Y;if(this.stats.distance+=Math.sqrt(v*v+M*M),E){const B=I?.008:.012,x=I?.92:.95;if(this.velocity.y+=B,this.keys[" "]){const $=I?.04:.06;this.velocity.y+=$}if(this.keys.shift){const $=I?.03:.04;this.velocity.y-=$}const F=I?.12:.15;this.velocity.y=Math.max(-F,Math.min(F,this.velocity.y)),this.velocity.y*=x,!H&&this.keys[" "]&&this.velocity.y<.15&&(this.velocity.y=.2)}else this.velocity.y+=this.gravity;const w=this.camera.y+this.velocity.y,S=this.getGroundHeightBelow(this.camera.x,this.camera.z,this.camera.y)+this.playerEyeHeight+.5;w<S?(this.camera.y=S,this.velocity.y=0,this.isJumping=!1,this.keys[" "]&&!E&&(this.velocity.y=.28,this.isJumping=!0,this.stats.jumps++)):this.camera.y=w;const C=this.getCeilingAbove(this.camera.x,this.camera.z,this.camera.y);C!==null&&this.camera.y>C-.5&&(this.camera.y=C-.5,this.velocity.y=0),this.worldBounds&&(this.camera.x<this.worldBounds.minX+.5&&(this.camera.x=this.worldBounds.minX+.5,this.velocity.x=Math.abs(this.velocity.x||0)*.3),this.camera.x>this.worldBounds.maxX-.5&&(this.camera.x=this.worldBounds.maxX-.5,this.velocity.x=-Math.abs(this.velocity.x||0)*.3),this.camera.z<this.worldBounds.minZ+.5&&(this.camera.z=this.worldBounds.minZ+.5,this.velocity.z=Math.abs(this.velocity.z||0)*.3),this.camera.z>this.worldBounds.maxZ-.5&&(this.camera.z=this.worldBounds.maxZ-.5,this.velocity.z=-Math.abs(this.velocity.z||0)*.3),this.camera.y<this.worldBounds.minY+this.playerEyeHeight&&(this.camera.y=this.worldBounds.minY+this.playerEyeHeight,this.velocity.y=.15)),this.settings.filter==="trippy"&&this.applyFilters()},collidesAt(t,i,e,a,s){const c=i-this.playerEyeHeight,f=[{x:t-a,z:e-a},{x:t+a,z:e-a},{x:t-a,z:e+a},{x:t+a,z:e+a},{x:t,z:e}];for(const h of f){const n=Math.floor(h.x),d=Math.floor(h.z);for(let m=Math.floor(c);m<Math.floor(c+s);m++){const u=this.getBlock(n,m,d);if(u&&!this.fluidBlocks.includes(u))return!0}}return!1},getGroundHeightBelow(t,i,e){const a=Math.floor(t),s=Math.floor(i),c=Math.floor(e-this.playerEyeHeight);for(let f=c;f>=0;f--){const h=this.getBlock(a,f,s);if(h&&!this.fluidBlocks.includes(h))return f+1}return 0},getCeilingAbove(t,i,e){const a=Math.floor(t),s=Math.floor(i),c=Math.floor(e);for(let f=c;f<=c+3;f++){const h=this.getBlock(a,f,s);if(h&&!this.fluidBlocks.includes(h))return f}return null},render(){if(!this.isActive)return;const t=this.ctx,i=this.canvas.width,e=this.canvas.height;if(!this.cachedSky||this.cachedSky.w!==i||this.cachedSky.h!==e||this.cachedSky.lighting!==this.settings.lighting){const o=t.createLinearGradient(0,0,0,e);this.settings.lighting?(o.addColorStop(0,"#1a0a1a"),o.addColorStop(.5,"#2d1f3d"),o.addColorStop(1,"#ffb7c5")):(o.addColorStop(0,"#111"),o.addColorStop(1,"#333")),this.cachedSky={grad:o,w:i,h:e,lighting:this.settings.lighting}}t.fillStyle=this.cachedSky.grad,t.fillRect(0,0,i,e);const a=this.camera.x,s=this.camera.y,c=this.camera.z,f=Math.cos(-this.camera.rotY),h=Math.sin(-this.camera.rotY),n=Math.cos(-this.camera.rotX),d=Math.sin(-this.camera.rotX),m=i/2,u=e/2,y=400,b=this.settings.renderDistance,T=b*b,P=(o,r,l)=>{const p=o-a,g=r-s,k=l-c,v=p*f-k*h,M=p*h+k*f,w=g*n-M*d,S=g*d+M*n;return S<=.1?null:{x:m+v/S*y,y:u-w/S*y,z:S}},L=[],z=-Math.sin(this.camera.rotY),R=Math.cos(this.camera.rotY),I=Object.keys(this.world);for(let o=0;o<I.length;o++){const r=I[o],[l,p,g]=r.split(",").map(Number),k=l+.5-a,v=p+.5-s,M=g+.5-c,w=k*k+v*v+M*M;w>T||k*z+M*R<-3&&w>16||L.push({x:l,y:p,z:g,dist:w,type:this.world[r]})}L.sort((o,r)=>r.dist-o.dist);const E=(o,r,l)=>this.world[`${o},${r},${l}`],H=o=>!o||this.fluidBlocks.includes(o),D=(o,r,l)=>this.fluidLevels[`${o},${r},${l}`]||8,Q=Date.now()*.002,U=[],X=[];for(let o=0;o<L.length;o++){const r=L[o],l=this.blockColors[r.type];l&&l.transparent?X.push(r):U.push(r)}const Z=(o,r,l)=>{const p=[[o+.5,r+.5,l+.5],[o+.1,r+.1,l+.1],[o+.9,r+.1,l+.1],[o+.1,r+.9,l+.1],[o+.9,r+.9,l+.1],[o+.1,r+.1,l+.9],[o+.9,r+.1,l+.9],[o+.1,r+.9,l+.9],[o+.9,r+.9,l+.9]];for(const[g,k,v]of p){const M=g-a,w=k-s,S=v-c,C=Math.sqrt(M*M+w*w+S*S);let B=!1;const x=Math.min(8,Math.ceil(C/2));for(let F=1;F<x;F++){const $=F/x,A=Math.floor(a+M*$),O=Math.floor(s+w*$),W=Math.floor(c+S*$);if(A===o&&O===r&&W===l)continue;const K=E(A,O,W);if(K&&!this.fluidBlocks.includes(K)){const V=this.blockColors[K];if(!V||!V.transparent){B=!0;break}}}if(!B)return!1}return!0},Y=X.filter(o=>!Z(o.x,o.y,o.z));Y.sort((o,r)=>r.dist-o.dist),U.sort((o,r)=>r.dist-o.dist);const q=[...U,...Y];for(let o=0;o<q.length;o++){const r=q[o],{x:l,y:p,z:g,type:k}=r,v=this.blockColors[k];if(!v)continue;const M=this.fluidBlocks.includes(k),w=M?D(l,p,g):8,S=p+w/8,C=E(l,p+1,g),B=E(l,p-1,g),x=E(l,p,g+1),F=E(l,p,g-1),$=E(l-1,p,g),A=E(l+1,p,g);let O,W,K,V,it,tt;if(M){O=!C||C!==k,W=!B||!this.fluidBlocks.includes(B);const et=w,st=x===k?D(l,p,g+1):0,J=F===k?D(l,p,g-1):0,ft=$===k?D(l-1,p,g):0,nt=A===k?D(l+1,p,g):0;K=!x||x!==k||st<et,V=!F||F!==k||J<et,it=!$||$!==k||ft<et,tt=!A||A!==k||nt<et}else O=H(C),W=H(B),K=H(x),V=H(F),it=H($),tt=H(A);if(!O&&!W&&!K&&!V&&!it&&!tt)continue;const N=[];K&&N.push({v:[[l,p,g+1],[l+1,p,g+1],[l+1,S,g+1],[l,S,g+1]],color:v.side,dark:1,isTop:!1}),V&&N.push({v:[[l+1,p,g],[l,p,g],[l,S,g],[l+1,S,g]],color:v.side,dark:.7,isTop:!1}),O&&N.push({v:[[l,S,g],[l+1,S,g],[l+1,S,g+1],[l,S,g+1]],color:v.top,dark:1,isTop:!0}),W&&N.push({v:[[l,p,g+1],[l+1,p,g+1],[l+1,p,g],[l,p,g]],color:v.bottom,dark:.7,isTop:!1}),it&&N.push({v:[[l,p,g],[l,p,g+1],[l,S,g+1],[l,S,g]],color:v.side,dark:.85,isTop:!1}),tt&&N.push({v:[[l+1,p,g+1],[l+1,p,g],[l+1,S,g],[l+1,S,g+1]],color:v.side,dark:.85,isTop:!1});for(let et=0;et<N.length;et++){const st=N[et],J=[];let ft=!0;for(let j=0;j<4;j++){const at=P(st.v[j][0],st.v[j][1],st.v[j][2]);if(!at){ft=!1;break}J.push(at)}if(!ft||J.length!==4)continue;let nt=st.color;if(this.settings.shadows&&st.dark<1&&(nt=this.darkenColor(st.color,st.dark)),M&&v.animated){if(k==="water"){const j=Q,at=Math.sin(j+l*.7+g*.5)*.4,gt=Math.sin(j*.8-l*.3+g*.7)*.3,yt=Math.sin(j*1.3+l*.5-g*.3)*.2,ut=(at+gt+yt)/3+.5,vt=l+.5-a,mt=p+.5-s,bt=g+.5-c,dt=Math.sqrt(vt*vt+mt*mt+bt*bt),Et=Math.abs(mt/(dt||1)),Ft=.02,kt=Ft+(1-Ft)*Math.pow(1-Et,5);let ot=0;const Dt=this.camera.x-(l+.5),$t=this.camera.z-(g+.5),Rt=Math.sqrt(Dt*Dt+$t*$t);Rt<5&&this.camera.y>p+1&&(ot=(1-Rt/5)*kt*.3);const Ht=[{r:255,g:183,b:197},{r:255,g:218,b:185},{r:135,g:206,b:235}],qt=Math.min(2,Math.floor((1-Et)*3)),Mt=Ht[qt],St=Math.min(1,dt/20),At=30+St*15,Wt=80+St*20,Ot=160-St*30,wt={r:100,g:60,b:40},ct=Math.min(.7,kt*1.5);let Bt=Math.floor(At*(1-ct)+Mt.r*ct),Pt=Math.floor(Wt*(1-ct)+Mt.g*ct),Tt=Math.floor(Ot*(1-ct)+Mt.b*ct);ot>0&&(Bt=Math.floor(Bt*(1-ot)+wt.r*ot),Pt=Math.floor(Pt*(1-ot)+wt.g*ot),Tt=Math.floor(Tt*(1-ot)+wt.b*ot));const xt={x:.5,y:.8,z:.3},It={x:vt/dt,y:mt/dt,z:bt/dt},lt={x:xt.x+It.x,y:xt.y+It.y,z:xt.z+It.z},Yt=Math.sqrt(lt.x*lt.x+lt.y*lt.y+lt.z*lt.z),Xt=Math.max(0,lt.y/Yt),pt=Math.pow(Xt,32)*ut*.6,Zt=Math.sin(j*2+l*1.5)*Math.cos(j*1.5+g*1.5),Nt=Math.sin(j*1.7-l*1.2+g*.8),jt=(Zt*Nt+1)*.1,zt=.85+ut*.15+pt+jt,_t=Math.min(255,Math.floor(Bt*zt+pt*200)),Gt=Math.min(255,Math.floor(Pt*zt+pt*180)),Ut=Math.min(255,Math.floor(Tt*zt+pt*150)),Kt=.55,Qt=kt*.35,Jt=Math.min(.9,Kt+Qt);nt=`rgba(${_t}, ${Gt}, ${Ut}, ${Jt})`}else if(k==="lava"){const j=Q*1.5+l*.3+g*.3,at=.8+Math.sin(j)*.2,gt=Math.floor(255*at),yt=Math.floor((80+Math.sin(j*2)*30)*at),ut=Math.floor(30*(1-at*.5));nt=`rgb(${Math.min(255,gt)}, ${Math.min(255,yt)}, ${ut})`}}t.fillStyle=nt,t.beginPath(),t.moveTo(J[0].x,J[0].y),t.lineTo(J[1].x,J[1].y),t.lineTo(J[2].x,J[2].y),t.lineTo(J[3].x,J[3].y),t.closePath(),t.fill(),M||(t.strokeStyle=this.darkenColor(nt,.7),t.lineWidth=.5,t.stroke())}}if(this.worldBounds){const o=this.worldBounds,r=Date.now()*.003,l=5,p=[{axis:"x",value:o.minX,dir:1},{axis:"x",value:o.maxX,dir:-1},{axis:"z",value:o.minZ,dir:1},{axis:"z",value:o.maxZ,dir:-1}];for(const k of p){let v;if(k.axis==="x"?v=Math.abs(a-k.value):v=Math.abs(c-k.value),!(v>b*1.5))for(let M=o.minY;M<o.maxY;M+=l){const w=k.axis==="x"?o.minZ:o.minX,S=k.axis==="x"?o.maxZ:o.maxX;for(let C=w;C<S;C+=l){let B,x;if(k.axis==="x"?(B=k.value,x=C+l/2):(B=C+l/2,x=k.value),Math.sqrt((B-a)**2+(x-c)**2)>b)continue;let $;const A=Math.min(M+l,o.maxY),O=Math.min(C+l,S);k.axis==="x"?$=[[k.value,M,C],[k.value,M,O],[k.value,A,O],[k.value,A,C]]:$=[[C,M,k.value],[O,M,k.value],[O,A,k.value],[C,A,k.value]];const W=[];let K=!0;for(const tt of $){const N=P(tt[0],tt[1],tt[2]);if(!N){K=!1;break}W.push(N)}if(!K||W.length<4)continue;const V=((C+M)*.2+r)%(Math.PI*2),it=.15+.1*Math.sin(V);t.fillStyle=`hsla(${180+Math.sin(r+C*.1)*20}, 100%, 60%, ${it})`,t.beginPath(),t.moveTo(W[0].x,W[0].y),t.lineTo(W[1].x,W[1].y),t.lineTo(W[2].x,W[2].y),t.lineTo(W[3].x,W[3].y),t.closePath(),t.fill(),t.strokeStyle=`hsla(180, 100%, 70%, ${it*2})`,t.lineWidth=1,t.stroke()}}}const g=o.minY;for(let k=o.minX;k<o.maxX;k+=l)for(let v=o.minZ;v<o.maxZ;v+=l){if(Math.sqrt((k+l/2-a)**2+(v+l/2-c)**2)>b)continue;const w=Math.min(k+l,o.maxX),S=Math.min(v+l,o.maxZ),C=[[k,g,v],[w,g,v],[w,g,S],[k,g,S]],B=[];let x=!0;for(const A of C){const O=P(A[0],A[1],A[2]);if(!O){x=!1;break}B.push(O)}if(!x||B.length<4)continue;const F=((k+v)*.2+r)%(Math.PI*2),$=.1+.08*Math.sin(F);t.fillStyle=`hsla(${280+Math.sin(r+k*.1)*20}, 100%, 50%, ${$})`,t.beginPath(),t.moveTo(B[0].x,B[0].y),t.lineTo(B[1].x,B[1].y),t.lineTo(B[2].x,B[2].y),t.lineTo(B[3].x,B[3].y),t.closePath(),t.fill(),t.strokeStyle=`hsla(280, 100%, 60%, ${$*2})`,t.lineWidth=1,t.stroke()}}for(const o of this.birds){const r=o.x-a,l=o.y-s,p=o.z-c;if(r*z+p*R<0||r*r+l*l+p*p>T)continue;const v=P(o.x,o.y,o.z);if(!v)continue;const M=o.size*y/v.z;if(M<2)continue;const w=Math.sin(o.wingPhase)*.5;o.angle+Math.PI/2,t.fillStyle="#d85a8a",t.beginPath(),t.ellipse(v.x,v.y,M*.8,M*.4,0,0,Math.PI*2),t.fill(),t.fillStyle="#ff9ec4";const S=M*1.5,C=M*.6*(1+w);t.beginPath(),t.moveTo(v.x,v.y),t.quadraticCurveTo(v.x-S*.5,v.y-C,v.x-S,v.y+M*.2),t.quadraticCurveTo(v.x-S*.5,v.y+M*.1,v.x,v.y),t.fill(),t.beginPath(),t.moveTo(v.x,v.y),t.quadraticCurveTo(v.x+S*.5,v.y-C,v.x+S,v.y+M*.2),t.quadraticCurveTo(v.x+S*.5,v.y+M*.1,v.x,v.y),t.fill(),t.fillStyle="#d85a8a",t.beginPath(),t.arc(v.x+M*.6,v.y-M*.1,M*.3,0,Math.PI*2),t.fill(),t.fillStyle="#ffaa00",t.beginPath(),t.moveTo(v.x+M*.9,v.y-M*.1),t.lineTo(v.x+M*1.2,v.y),t.lineTo(v.x+M*.9,v.y+M*.1),t.fill()}for(const o of this.pestBirds){const r=P(o.x,o.y,o.z);if(!r)continue;const l=o.size*y/r.z;if(l<1)continue;const p=Math.sin(o.wingPhase)*.7,g=o.anger||0,k=Math.min(255,107+g*30),v=Math.max(0,68-g*10),M=Math.max(0,35-g*7),w=o.state==="swooping",S=g>0?`rgb(${k}, ${v}, ${M})`:w?"#8b4513":"#6b4423",C=g>0?`rgb(${Math.min(255,k+30)}, ${v+20}, ${M+10})`:w?"#a0522d":"#8b7355";t.fillStyle=S,t.beginPath(),t.ellipse(r.x,r.y,l*.6,l*.5,0,0,Math.PI*2),t.fill(),g>=3&&(t.shadowColor="#ff0000",t.shadowBlur=g*3),t.fillStyle=C;const B=l*1.2,x=l*.8*(1+p);t.beginPath(),t.moveTo(r.x,r.y),t.quadraticCurveTo(r.x-B*.4,r.y-x,r.x-B,r.y),t.quadraticCurveTo(r.x-B*.4,r.y+l*.2,r.x,r.y),t.fill(),t.beginPath(),t.moveTo(r.x,r.y),t.quadraticCurveTo(r.x+B*.4,r.y-x,r.x+B,r.y),t.quadraticCurveTo(r.x+B*.4,r.y+l*.2,r.x,r.y),t.fill(),t.fillStyle=S,t.beginPath(),t.arc(r.x+l*.4,r.y-l*.15,l*.25,0,Math.PI*2),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(r.x+l*.45,r.y-l*.2,l*.08,0,Math.PI*2),t.fill(),t.fillStyle="#ff6600",t.beginPath(),t.moveTo(r.x+l*.6,r.y-l*.15),t.lineTo(r.x+l*.85,r.y-l*.1),t.lineTo(r.x+l*.6,r.y-l*.05),t.fill(),t.fillStyle=C,t.beginPath(),t.moveTo(r.x-l*.4,r.y),t.lineTo(r.x-l*.9,r.y-l*.1),t.lineTo(r.x-l*.95,r.y+l*.05),t.lineTo(r.x-l*.85,r.y+l*.15),t.lineTo(r.x-l*.4,r.y+l*.1),t.fill(),t.shadowBlur=0,t.shadowColor="transparent"}if(this.blueBirds)for(const o of this.blueBirds){const r=P(o.x,o.y,o.z);if(!r)continue;const l=Math.max(8,25/r.z),p=Math.sin(o.wingPhase)*.6,g=l*.5*(1+p);t.fillStyle="#1e90ff",t.beginPath(),t.ellipse(r.x,r.y,l*.5,l*.3,0,0,Math.PI*2),t.fill(),t.fillStyle="#00bfff";const k=l*1.2;t.beginPath(),t.moveTo(r.x,r.y),t.quadraticCurveTo(r.x-k*.5,r.y-g,r.x-k,r.y),t.quadraticCurveTo(r.x-k*.5,r.y+l*.2,r.x,r.y),t.fill(),t.beginPath(),t.moveTo(r.x,r.y),t.quadraticCurveTo(r.x+k*.5,r.y-g,r.x+k,r.y),t.quadraticCurveTo(r.x+k*.5,r.y+l*.2,r.x,r.y),t.fill(),t.fillStyle="#ff0000",t.beginPath(),t.arc(r.x+l*.3,r.y-l*.1,l*.15,0,Math.PI*2),t.fill()}if(this.fish)for(const o of this.fish){const r=P(o.x,o.y,o.z);if(!r)continue;const l=Math.max(4,o.size*30/r.z),p=Math.sin(o.swimPhase)*.2;t.save(),t.translate(r.x,r.y),t.rotate(Math.atan2(o.vz,o.vx)+p),t.fillStyle=o.color,t.beginPath(),t.ellipse(0,0,l,l*.4,0,0,Math.PI*2),t.fill(),t.beginPath(),t.moveTo(-l*.8,0),t.lineTo(-l*1.5,-l*.4),t.lineTo(-l*1.5,l*.4),t.closePath(),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(l*.5,-l*.1,l*.15,0,Math.PI*2),t.fill(),t.restore()}if(this.cats)for(const o of this.cats){const r=P(o.x,o.y+.3,o.z);if(!r)continue;const l=Math.max(10,40/r.z),p=Math.sin(o.walkPhase)*l*.05;t.fillStyle=o.color,t.beginPath(),t.ellipse(r.x,r.y+p,l*.6,l*.4,0,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(r.x+l*.5,r.y-l*.2+p,l*.35,0,Math.PI*2),t.fill(),t.beginPath(),t.moveTo(r.x+l*.3,r.y-l*.5+p),t.lineTo(r.x+l*.4,r.y-l*.2+p),t.lineTo(r.x+l*.5,r.y-l*.5+p),t.fill(),t.beginPath(),t.moveTo(r.x+l*.6,r.y-l*.5+p),t.lineTo(r.x+l*.7,r.y-l*.2+p),t.lineTo(r.x+l*.5,r.y-l*.5+p),t.fill(),t.fillStyle="#00ff00",t.beginPath(),t.ellipse(r.x+l*.4,r.y-l*.25+p,l*.08,l*.12,0,0,Math.PI*2),t.fill(),t.beginPath(),t.ellipse(r.x+l*.6,r.y-l*.25+p,l*.08,l*.12,0,0,Math.PI*2),t.fill(),t.strokeStyle=o.color,t.lineWidth=l*.1,t.lineCap="round",t.beginPath(),t.moveTo(r.x-l*.5,r.y+p),t.quadraticCurveTo(r.x-l*.8,r.y-l*.3,r.x-l*.7,r.y-l*.5),t.stroke()}if(this.creepers)for(const o of this.creepers){const r=P(o.x,o.y+.8,o.z);if(!r)continue;const l=Math.max(15,50/r.z),p=o.state==="fusing"&&o.flashing?"#ffffff":"#00aa00";t.fillStyle=p,t.fillRect(r.x-l*.3,r.y-l*.5,l*.6,l),t.fillRect(r.x-l*.35,r.y-l*.9,l*.7,l*.5),t.fillStyle="#000",t.fillRect(r.x-l*.25,r.y-l*.8,l*.15,l*.15),t.fillRect(r.x+l*.1,r.y-l*.8,l*.15,l*.15),t.fillRect(r.x-l*.2,r.y-l*.55,l*.1,l*.15),t.fillRect(r.x+l*.1,r.y-l*.55,l*.1,l*.15),t.fillRect(r.x-l*.1,r.y-l*.5,l*.2,l*.1),t.fillStyle=p,t.fillRect(r.x-l*.3,r.y+l*.4,l*.2,l*.3),t.fillRect(r.x+l*.1,r.y+l*.4,l*.2,l*.3)}for(const o of this.particles){const r=P(o.x,o.y,o.z);if(r){if(o.type==="bullet"){const l=o.x-this.camera.x,p=o.y-this.camera.y,g=o.z-this.camera.z;let k=!1;for(let M=.3;M<.95;M+=.2){const w=this.camera.x+l*M,S=this.camera.y+p*M,C=this.camera.z+g*M,B=this.getBlock(Math.floor(w),Math.floor(S),Math.floor(C));if(B&&!this.fluidBlocks.includes(B)){k=!0;break}}if(k)continue;if(o.trail.length>1){t.strokeStyle="rgba(255, 200, 50, 0.8)",t.lineWidth=2,t.beginPath();let M=!1;for(let w=0;w<o.trail.length;w++){const S=P(o.trail[w].x,o.trail[w].y,o.trail[w].z);S&&(M?t.lineTo(S.x,S.y):(t.moveTo(S.x,S.y),M=!0))}M&&(t.lineTo(r.x,r.y),t.stroke())}const v=Math.max(2,8/r.z);t.fillStyle="#ffcc00",t.beginPath(),t.arc(r.x,r.y,v,0,Math.PI*2),t.fill()}else if(o.type==="ricochet"||o.type==="spark"){const l=Math.max(1,(o.size||3)*20/r.z),p=Math.min(1,o.life/15);t.fillStyle=`rgba(255, ${150+Math.random()*100}, 50, ${p})`,t.beginPath(),t.arc(r.x,r.y,l,0,Math.PI*2),t.fill()}else if(o.type==="blessing"){const l=Math.max(2,(o.size||4)*20/r.z),p=Math.min(1,o.life/30),g=Math.sin(o.life*.3)*.5+.5;t.fillStyle=`rgba(255, 215, 0, ${p*.3})`,t.beginPath(),t.arc(r.x,r.y,l*2,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, ${200+g*55}, ${100+g*155}, ${p})`,t.beginPath(),t.arc(r.x,r.y,l,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 255, 255, ${p*g})`,t.beginPath(),t.arc(r.x,r.y,l*.3,0,Math.PI*2),t.fill()}else if(o.type==="explosion"){const l=Math.max(3,(o.size||5)*25/r.z),p=Math.min(1,o.life/20),g=Math.random()*.3+.7;t.fillStyle=`rgba(255, 100, 0, ${p*.4})`,t.beginPath(),t.arc(r.x,r.y,l*1.5,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, ${150+Math.random()*100}, 0, ${p*g})`,t.beginPath(),t.arc(r.x,r.y,l,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 255, ${Math.random()*100}, ${p*.8})`,t.beginPath(),t.arc(r.x,r.y,l*.4,0,Math.PI*2),t.fill()}else if(o.type==="feather"){const l=Math.max(2,15/r.z),p=Math.min(1,o.life/20);t.save(),t.translate(r.x,r.y),t.rotate(o.rotation),t.fillStyle=`rgba(139, 90, 43, ${p})`,t.beginPath(),t.ellipse(0,0,l*2,l*.5,0,0,Math.PI*2),t.fill(),t.strokeStyle=`rgba(100, 60, 30, ${p})`,t.lineWidth=1,t.beginPath(),t.moveTo(-l*2,0),t.lineTo(l*2,0),t.stroke(),t.restore()}else if(o.type==="petal"){const l=o.x-this.camera.x,p=o.y-this.camera.y,g=o.z-this.camera.z;let k=!1;for(let w=.2;w<.9;w+=.25){const S=this.camera.x+l*w,C=this.camera.y+p*w,B=this.camera.z+g*w,x=this.getBlock(Math.floor(S),Math.floor(C),Math.floor(B));if(x&&!this.fluidBlocks.includes(x)){k=!0;break}}if(k)continue;const v=Math.max(2,(o.size||4)*15/r.z),M=Math.min(1,o.life/50);t.save(),t.translate(r.x,r.y),t.rotate(o.rotation),t.fillStyle=`rgba(255, 183, 197, ${M})`,t.beginPath(),t.ellipse(0,0,v*1.5,v*.7,0,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 150, 170, ${M})`,t.beginPath(),t.ellipse(0,0,v*.5,v*.3,0,0,Math.PI*2),t.fill(),t.restore()}else if(o.type==="burger"){const l=Math.max(3,(o.size||8)*20/r.z);t.save(),t.translate(r.x,r.y),t.fillStyle="#D2691E",t.beginPath(),t.ellipse(0,-l*.3,l,l*.5,0,Math.PI,0),t.fill(),t.fillStyle="#654321",t.fillRect(-l,-l*.2,l*2,l*.4),t.fillStyle="#228B22",t.fillRect(-l*.9,l*.1,l*1.8,l*.15),t.fillStyle="#DEB887",t.beginPath(),t.ellipse(0,l*.3,l,l*.4,0,0,Math.PI),t.fill(),t.restore()}else if(o.type==="burgerSplat"){const l=Math.max(2,(o.size||4)*10/r.z),p=Math.min(1,o.life/10),g=["#D2691E","#654321","#228B22","#FF6347"];t.fillStyle=g[Math.floor(Math.random()*g.length)].replace(")",`, ${p})`).replace("rgb","rgba"),t.beginPath(),t.arc(r.x,r.y,l,0,Math.PI*2),t.fill()}else if(o.type==="apple"){const l=Math.max(3,(o.size||6)*18/r.z);t.save(),t.translate(r.x,r.y),t.fillStyle="#dc143c",t.beginPath(),t.arc(0,0,l,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.3)",t.beginPath(),t.arc(-l*.3,-l*.3,l*.4,0,Math.PI*2),t.fill(),t.fillStyle="#654321",t.fillRect(-1,-l-3,2,4),t.fillStyle="#228b22",t.beginPath(),t.ellipse(3,-l-1,4,2,.3,0,Math.PI*2),t.fill(),t.restore()}else if(o.type==="appleSplat"){const l=Math.max(2,(o.size||3)*8/r.z),p=Math.min(1,o.life/10);t.fillStyle=`rgba(220, 20, 60, ${p})`,t.beginPath(),t.arc(r.x,r.y,l,0,Math.PI*2),t.fill()}}}if(this.droppedItems)for(const r of this.droppedItems){const l=r.x-a,p=r.y-s,g=r.z-c;if(l*l+p*p+g*g>400)continue;let v=!1;for(let C=.15;C<.9;C+=.2){const B=a+l*C,x=s+p*C,F=c+g*C,$=this.getBlock(Math.floor(B),Math.floor(x),Math.floor(F));if($&&!this.fluidBlocks.includes($)){v=!0;break}}if(v)continue;const M=Math.sin(r.bobPhase)*.1,w=P(r.x,r.y+M,r.z);if(!w||w.z<=0)continue;const S=Math.max(6,30/w.z);this.drawDroppedItem3D(t,w.x,w.y,S,r.type,r.bobPhase),r.count>1&&(t.font=`bold ${Math.max(8,S*.5)}px monospace`,t.fillStyle="#fff",t.strokeStyle="#000",t.lineWidth=2,t.textAlign="center",t.strokeText(r.count.toString(),w.x+S*.5,w.y+S*.4),t.fillText(r.count.toString(),w.x+S*.5,w.y+S*.4))}if(!this.isPaused&&this.pointerLocked){const o=this.raycast();if(o&&o.hit){const r=o.hit.x,l=o.hit.y,p=o.hit.z,g=.005,v=[[r-g,l-g,p-g],[r+1+g,l-g,p-g],[r+1+g,l+1+g,p-g],[r-g,l+1+g,p-g],[r-g,l-g,p+1+g],[r+1+g,l-g,p+1+g],[r+1+g,l+1+g,p+1+g],[r-g,l+1+g,p+1+g]].map(w=>P(w[0],w[1],w[2]));if(v.every(w=>w!==null)){let w="rgba(0, 0, 0, 0.8)",S=2;o.throughWater?(w="rgba(74, 144, 217, 0.7)",S=3):o.throughLava&&(w="rgba(255, 100, 0, 0.7)",S=3),t.strokeStyle=w,t.lineWidth=S;const C=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];t.beginPath();for(const[B,x]of C)t.moveTo(v[B].x,v[B].y),t.lineTo(v[x].x,v[x].y);t.stroke()}const M=this.getBlock(r,l,p);this.updateBlockTooltip(M)}else this.updateBlockTooltip(null)}if(this.debugShowCoords&&(t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(i-200,10,190,80),t.fillStyle="#0f0",t.font="12px monospace",t.textAlign="left",t.fillText(`X: ${this.camera.x.toFixed(2)}`,i-190,28),t.fillText(`Y: ${this.camera.y.toFixed(2)}`,i-190,43),t.fillText(`Z: ${this.camera.z.toFixed(2)}`,i-190,58),t.fillText(`Blocks: ${Object.keys(this.world).length}`,i-190,73),t.fillText(`Birds: ${this.pestBirds.length}`,i-190,88)),this.renderPlayerModel(t,m,u,i,e),!this.isPaused&&this.pointerLocked&&(t.strokeStyle="#fff",t.lineWidth=2,t.beginPath(),t.moveTo(m-10,u),t.lineTo(m+10,u),t.moveTo(m,u-10),t.lineTo(m,u+10),t.stroke()),this.birdEvent&&this.birdEvent.alertMessage&&this.birdEvent.alertFade>0){const o=Math.min(1,this.birdEvent.alertFade/1e3),r=.8+Math.sin(Date.now()*.01)*.2;t.save(),t.globalAlpha=o,t.fillStyle=`rgba(0, 0, 0, ${.7*r})`;const l=Math.min(i*.8,500),p=60,g=(i-l)/2,k=80;t.fillRect(g,k,l,p),t.strokeStyle=`rgba(255, 100, 100, ${r})`,t.lineWidth=3,t.strokeRect(g,k,l,p),t.fillStyle=`rgba(255, 255, 255, ${r})`,t.font="bold 20px monospace",t.textAlign="center",t.fillText(this.birdEvent.alertMessage,i/2,k+38),t.restore()}if(this.birdEvent&&!this.isPaused){const o=Math.max(0,this.birdEvent.timer),r=Math.floor(o/6e4),l=Math.floor(o%6e4/1e3),p=`üê¶ ${r}:${l.toString().padStart(2,"0")}`;t.save(),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(i-100,10,90,25),t.fillStyle=o<6e4?"#ff6666":"#fff",t.font="14px monospace",t.textAlign="right",t.fillText(p,i-15,28),t.restore()}if(this.selectedItem==="ak47"&&!this.isPaused){const o=Math.min(i,e)*.0055,r=i*.75,l=e*.78;t.save(),t.translate(r,l),t.rotate(-.1),t.fillStyle="#d4a574",t.beginPath(),t.ellipse(45*o,25*o,18*o,12*o,.3,0,Math.PI*2),t.fill(),t.fillStyle="#c49a6c";for(let p=0;p<4;p++)t.beginPath(),t.ellipse((35+p*7)*o,35*o,4*o,8*o,.2,0,Math.PI*2),t.fill();t.fillStyle="#d4a574",t.beginPath(),t.ellipse(30*o,15*o,6*o,10*o,-.5,0,Math.PI*2),t.fill(),t.fillStyle="#5a3d2b",t.beginPath(),t.moveTo(80*o,-5*o),t.lineTo(160*o,0*o),t.lineTo(165*o,25*o),t.lineTo(155*o,30*o),t.lineTo(80*o,25*o),t.closePath(),t.fill(),t.fillStyle="#6b4d3b",t.fillRect(100*o,2*o,50*o,8*o),t.fillRect(95*o,15*o,55*o,6*o),t.fillStyle="#333",t.fillRect(155*o,-2*o,8*o,30*o),t.fillStyle="#2a2a2a",t.fillRect(-30*o,-8*o,115*o,30*o),t.fillStyle="#3a3a3a",t.fillRect(-25*o,-12*o,100*o,8*o),t.fillStyle="#1a1a1a",t.fillRect(15*o,-6*o,25*o,12*o),t.fillStyle="#1a1a1a",t.fillRect(-140*o,-4*o,115*o,14*o),t.fillStyle="#111",t.fillRect(-180*o,0*o,45*o,8*o),t.fillStyle="#000",t.beginPath(),t.ellipse(-182*o,4*o,3*o,3*o,0,0,Math.PI*2),t.fill(),t.fillStyle="#333",t.fillRect(-130*o,-10*o,100*o,5*o),t.fillStyle="#111";for(let p=0;p<4;p++)t.beginPath(),t.ellipse((-120+p*22)*o,3*o,6*o,3*o,0,0,Math.PI*2),t.fill();t.fillStyle="#1a1a1a",t.fillRect(-145*o,-20*o,6*o,18*o),t.fillRect(-148*o,-22*o,12*o,4*o),t.fillRect(-5*o,-18*o,15*o,8*o),t.fillStyle="#333",t.beginPath(),t.moveTo(10*o,22*o),t.lineTo(35*o,22*o),t.quadraticCurveTo(45*o,50*o,35*o,80*o),t.lineTo(15*o,85*o),t.quadraticCurveTo(5*o,55*o,10*o,22*o),t.closePath(),t.fill(),t.strokeStyle="#222",t.lineWidth=1.5*o;for(let p=0;p<4;p++)t.beginPath(),t.moveTo((12+p*2)*o,(35+p*12)*o),t.lineTo((32+p*1)*o,(38+p*12)*o),t.stroke();t.fillStyle="#5a3d2b",t.beginPath(),t.moveTo(45*o,22*o),t.lineTo(65*o,22*o),t.lineTo(70*o,65*o),t.lineTo(45*o,70*o),t.closePath(),t.fill(),t.fillStyle="#4a2d1b";for(let p=0;p<5;p++)t.fillRect(50*o,(28+p*8)*o,12*o,3*o);if(t.strokeStyle="#2a2a2a",t.lineWidth=3*o,t.beginPath(),t.arc(25*o,35*o,15*o,-.8,2.2),t.stroke(),t.fillStyle="#222",t.fillRect(22*o,28*o,4*o,12*o),this.muzzleFlash>0){const p=25+Math.random()*20,g=-190*o,k=4*o;t.fillStyle="rgba(255, 100, 0, 0.5)",t.beginPath(),t.arc(g,k,p*o*1.5,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 150, 0, 0.8)",t.beginPath(),t.arc(g,k,p*o,0,Math.PI*2),t.fill(),t.fillStyle="#ffff00",t.beginPath(),t.arc(g,k,p*o*.4,0,Math.PI*2),t.fill(),t.strokeStyle="#ffff88",t.lineWidth=2;for(let v=0;v<6;v++){const M=Math.PI+(Math.random()-.5)*1.5,w=(20+Math.random()*35)*o;t.beginPath(),t.moveTo(g,k),t.lineTo(g+Math.cos(M)*w,k+Math.sin(M)*w),t.stroke()}}t.restore()}if(this.headSubmergedWater&&(t.fillStyle="rgba(0, 100, 200, 0.25)",t.fillRect(0,0,i,e)),this.headSubmergedLava){const o=Date.now()*.005;t.fillStyle="rgba(255, 80, 0, 0.4)",t.fillRect(0,0,i,e),t.fillStyle="rgba(255, 50, 0, 0.6)";for(let l=0;l<12;l++){const p=l/12*i,g=60+Math.sin(o+l*.8)*30+Math.sin(o*1.5+l)*20;t.beginPath(),t.moveTo(p-30,e),t.quadraticCurveTo(p,e-g,p+30,e),t.fill()}t.fillStyle="rgba(255, 100, 0, 0.5)";for(let l=0;l<8;l++){const p=l/8*i+40,g=40+Math.sin(o*.8+l*1.2)*25;t.beginPath(),t.moveTo(p-25,0),t.quadraticCurveTo(p,g,p+25,0),t.fill()}t.fillStyle="rgba(255, 60, 0, 0.5)";for(let l=0;l<6;l++){const p=l/6*e,g=40+Math.sin(o+l)*20;t.beginPath(),t.moveTo(0,p-30),t.quadraticCurveTo(g,p,0,p+30),t.fill(),t.beginPath(),t.moveTo(i,p-30),t.quadraticCurveTo(i-g,p,i,p+30),t.fill()}const r=t.createRadialGradient(i/2,e/2,0,i/2,e/2,i*.7);r.addColorStop(0,"rgba(255, 50, 0, 0)"),r.addColorStop(.7,"rgba(255, 30, 0, 0.3)"),r.addColorStop(1,"rgba(200, 0, 0, 0.6)"),t.fillStyle=r,t.fillRect(0,0,i,e)}},project(t,i,e){const a=t-this.camera.x,s=i-this.camera.y,c=e-this.camera.z,f=Math.cos(-this.camera.rotY),h=Math.sin(-this.camera.rotY),n=a*f-c*h,d=a*h+c*f,m=Math.cos(-this.camera.rotX),u=Math.sin(-this.camera.rotX),y=s*m-d*u,b=s*u+d*m;if(b<=.1)return null;const T=400,P=this.canvas.width/2+n/b*T,L=this.canvas.height/2-y/b*T;return{x:P,y:L,z:b}},updateBlockTooltip(t){const i=document.getElementById("blockTooltip");if(!i)return;const a=t?{petalSocket:{name:"Petal Socket",item:"Requires: Sakura Petal",desc:"Place a cherry blossom petal here"},ropeSocket:{name:"Rope Socket",item:"Requires: Sacred Rope",desc:"Place a shimenawa rope here"},charmSocket:{name:"Charm Socket",item:"Requires: Omamori",desc:"Place the protective charm here"},plaqueSocket:{name:"Plaque Socket",item:"Requires: Wish Plaque",desc:"Place a wooden ema here"},incenseSocket:{name:"Incense Socket",item:"Requires: Incense",desc:"Place purifying incense here"},petalSocketFilled:{name:"Petal Socket ‚úì",item:"FILLED",desc:"Cherry petal placed!"},ropeSocketFilled:{name:"Rope Socket ‚úì",item:"FILLED",desc:"Sacred rope placed!"},charmSocketFilled:{name:"Charm Socket ‚úì",item:"FILLED",desc:"Charm placed!"},plaqueSocketFilled:{name:"Plaque Socket ‚úì",item:"FILLED",desc:"Wish plaque placed!"},incenseSocketFilled:{name:"Incense Socket ‚úì",item:"FILLED",desc:"Incense placed!"}}[t]:null;if(a){i.classList.add("active"),i.querySelector(".tooltip-title").textContent=a.name;const s=a.item==="FILLED";i.querySelector(".tooltip-desc").innerHTML=`<span style="color:${s?"#4f4":"#ffd700"}">${a.item}</span><br>${a.desc}`}else i.classList.remove("active")},renderPlayerModel(t,i,e,a,s){const c=Math.max(0,this.camera.rotX*2);if(c<.05){this.renderHeldItem(t,i,e,a,s);return}const f=Math.min(1,c);t.save();const h=s-50+(1-c)*200;this.drawPlayerBody3D(t,i,h,f,c),t.restore(),this.renderHeldItem(t,i,e,a,s)},renderHeldItem(t,i,e,a,s){const c=this.inventory.hotbar[this.selectedSlot];if(!c)return;const f=c.id,h=Math.sin(Date.now()*.003)*3,n=a-120,d=s-100+h,m=60;t.save(),t.translate(n,d),t.rotate(-.2),t.fillStyle="#ffdab9",t.beginPath(),t.ellipse(0,20,25,35,.3,0,Math.PI*2),t.fill();const u=this.blockColors[f];if(u){const y=m*.5;t.translate(0,-10),t.fillStyle=u.top,t.beginPath(),t.moveTo(0,-y),t.lineTo(y,-y/2),t.lineTo(0,0),t.lineTo(-y,-y/2),t.closePath(),t.fill(),t.fillStyle=u.side,t.beginPath(),t.moveTo(-y,-y/2),t.lineTo(0,0),t.lineTo(0,y),t.lineTo(-y,y/2),t.closePath(),t.fill(),t.fillStyle=this.darkenColor(u.side,.7),t.beginPath(),t.moveTo(0,0),t.lineTo(y,-y/2),t.lineTo(y,y/2),t.lineTo(0,y),t.closePath(),t.fill()}else if(f==="ak47")t.fillStyle="#333",t.fillRect(-30,-20,80,15),t.fillStyle="#8b4513",t.fillRect(-10,-5,25,25),t.fillStyle="#222",t.fillRect(10,-5,8,20);else if(f==="berdger")t.fillStyle="#daa520",t.beginPath(),t.ellipse(0,-15,25,12,0,Math.PI,0),t.fill(),t.fillStyle="#8b4513",t.fillRect(-22,-8,44,10),t.fillStyle="#228b22",t.fillRect(-20,0,40,5),t.fillStyle="#daa520",t.beginPath(),t.ellipse(0,10,23,10,0,0,Math.PI),t.fill();else if(f==="apple")t.fillStyle="#dc143c",t.beginPath(),t.arc(0,-5,20,0,Math.PI*2),t.fill(),t.fillStyle="#654321",t.fillRect(-2,-30,4,10),t.fillStyle="#228b22",t.beginPath(),t.ellipse(5,-28,8,4,.5,0,Math.PI*2),t.fill();else if(f==="water_bucket"||f==="lava_bucket")t.fillStyle="#888",t.beginPath(),t.moveTo(-20,-25),t.lineTo(20,-25),t.lineTo(15,15),t.lineTo(-15,15),t.closePath(),t.fill(),t.fillStyle=f==="water_bucket"?"#4a90d9":"#ff6600",t.fillRect(-15,-15,30,25);else if(f==="seeds"){t.fillStyle="#daa520";for(let y=0;y<5;y++)t.beginPath(),t.ellipse(Math.cos(y)*10,Math.sin(y)*8-10,4,6,y,0,Math.PI*2),t.fill()}t.restore()},drawPlayerBody3D(t,i,e,a,s){t.save();const c=t.createLinearGradient(i-50,e,i+50,e);c.addColorStop(0,`rgba(180, 130, 150, ${a})`),c.addColorStop(.3,`rgba(255, 183, 197, ${a})`),c.addColorStop(.7,`rgba(255, 183, 197, ${a})`),c.addColorStop(1,`rgba(180, 130, 150, ${a})`),t.fillStyle=c,t.beginPath(),t.moveTo(i-35,e+5),t.lineTo(i+35,e+5),t.quadraticCurveTo(i+50,e+40,i+45,e+80),t.lineTo(i-45,e+80),t.quadraticCurveTo(i-50,e+40,i-35,e+5),t.closePath(),t.fill(),t.fillStyle=`rgba(255, 240, 245, ${a*.8})`,t.beginPath(),t.moveTo(i-20,e+5),t.lineTo(i,e+25),t.lineTo(i+20,e+5),t.closePath(),t.fill();const f=t.createRadialGradient(i-55,e+30,0,i-55,e+30,30);f.addColorStop(0,`rgba(255, 228, 205, ${a})`),f.addColorStop(1,`rgba(220, 180, 160, ${a})`),t.fillStyle=f,t.beginPath(),t.ellipse(i-52,e+35,14,28,-.2,0,Math.PI*2),t.fill();const h=t.createRadialGradient(i+55,e+30,0,i+55,e+30,30);h.addColorStop(0,`rgba(255, 228, 205, ${a})`),h.addColorStop(1,`rgba(220, 180, 160, ${a})`),t.fillStyle=h,t.beginPath(),t.ellipse(i+52,e+35,14,28,.2,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 218, 195, ${a})`,t.beginPath(),t.arc(i-55,e+60,12,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(i+55,e+60,12,0,Math.PI*2),t.fill();const n=t.createLinearGradient(i-40,e+75,i+40,e+75);n.addColorStop(0,`rgba(50, 70, 100, ${a})`),n.addColorStop(.3,`rgba(70, 90, 120, ${a})`),n.addColorStop(.7,`rgba(70, 90, 120, ${a})`),n.addColorStop(1,`rgba(50, 70, 100, ${a})`),t.fillStyle=n,t.beginPath(),t.roundRect(i-38,e+78,28,55,3),t.fill(),t.beginPath(),t.roundRect(i+10,e+78,28,55,3),t.fill(),t.fillStyle=`rgba(100, 60, 30, ${a})`,t.beginPath(),t.roundRect(i-42,e+128,35,20,4),t.fill(),t.beginPath(),t.roundRect(i+7,e+128,35,20,4),t.fill(),t.fillStyle=`rgba(255, 255, 255, ${a*.2})`,t.beginPath(),t.ellipse(i-30,e+133,8,3,0,0,Math.PI*2),t.fill(),t.beginPath(),t.ellipse(i+20,e+133,8,3,0,0,Math.PI*2),t.fill(),t.restore()},darkenColor(t,i){const e=t+i;if(this.colorCache||(this.colorCache={}),this.colorCache[e])return this.colorCache[e];const a=Math.floor(parseInt(t.slice(1,3),16)*i),s=Math.floor(parseInt(t.slice(3,5),16)*i),c=Math.floor(parseInt(t.slice(5,7),16)*i),f=`rgb(${a},${s},${c})`;return this.colorCache[e]=f,f},gameLoop(t){if(!this.isActive){this.gameLoopId=null;return}this.lastFrameTime||(this.lastFrameTime=t);const i=1e3/this.settings.targetFps,e=t-this.lastFrameTime;if(e>=i){if(this.lastFrameTime=t-e%i,this.fpsCounter.frames++,t-this.fpsCounter.lastTime>=1e3){this.fpsCounter.fps=this.fpsCounter.frames,this.fpsCounter.frames=0,this.fpsCounter.lastTime=t;const a=document.getElementById("debugFps");a&&(a.textContent=`${this.fpsCounter.fps} FPS`)}this.isPaused||(this.update(),this.updateBirds(),this.updateParticles(),this.updateFluids(),this.updateWind(),this.updatePetals(),this.updateDroppedItems(),this.render(),this.settings.showFps&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(this.canvas.width-70,this.canvas.height-25,65,20),this.ctx.fillStyle="#00ff00",this.ctx.font="12px monospace",this.ctx.textAlign="right",this.ctx.fillText(`${this.fpsCounter.fps} FPS`,this.canvas.width-10,this.canvas.height-10),this.ctx.textAlign="left"))}this.gameLoopId=requestAnimationFrame(a=>this.gameLoop(a))},start(){this.fullInit(),this.isActive=!0,this.isPaused=!1,this.pointerLocked=!1,this.stats={blocksPlaced:0,blocksBroken:0,distance:0,jumps:0,startTime:Date.now()},document.getElementById("minecraftGame").classList.add("active"),document.getElementById("pauseMenu").classList.remove("active"),document.getElementById("gameUI").style.display="flex";const i=(()=>{const f=(d,m)=>{let u=null;for(let E=40;E>=0;E--){const H=this.getBlock(d,E,m);if(H&&H!=="water"&&H!=="lava"){u=E;break}}if(u===null)return null;const y=u+1,b=u+2,T=this.getBlock(d,y,m),P=this.getBlock(d,b,m),L=!T||T==="water"||T==="lava",z=!P||P==="water"||P==="lava",R=this.getBlock(d,u,m),I=R!=="water"&&R!=="lava"&&R!=="sand";return L&&z?{x:d,y:y+this.playerEyeHeight,z:m,priority:I?1:2}:null};let h=f(0,-8);if(h&&h.priority===1)return h;const n=30;for(let d=1;d<=n;d++){for(let m=-d;m<=d;m++)for(let u=-d;u<=d;u++){if(Math.abs(m)!==d&&Math.abs(u)!==d)continue;const y=f(0+m,-8+u);if(y){if(y.priority===1)return y;(!h||y.priority<h.priority)&&(h=y)}}if(h&&d>5)return h}return{x:0,y:30,z:0}})();this.camera={x:i.x+.5,y:i.y,z:i.z+.5,rotX:-.3,rotY:0},this.canvas.style.filter="",this.velocity={x:0,y:0,z:0},this.isJumping=!1,this.inWater=!1,this.inLava=!1,this.swimming=!1,this.headSubmergedWater=!1,this.headSubmergedLava=!1,this.particles=[],this.fluidUpdates=[],this.birdEvent={timer:5*60*1e3,lastUpdate:Date.now(),currentEvent:0,events:[{name:"SWARM",description:"the birds will swarm!",action:()=>this.triggerBirdSwarm()},{name:"RAGE",description:"the birds will rage!",action:()=>this.triggerBirdRage()},{name:"MULTIPLY",description:"the birds will multiply!",action:()=>this.triggerBirdMultiply()},{name:"CREEPER INVASION",description:"creepers will stalk you!",action:()=>this.triggerCreeperInvasion()}],alertShown:{five:!1,three:!1,one:!1,thirty:!1,ten:!1},alertMessage:null,alertFade:0},this.survivalStats={score:0,wave:1,birdsDefeated:0,objectiveTimer:0,currentObjective:null,objectives:[{text:"Survive the bird apocalypse!",type:"survive"},{text:"Find the Ritual Temple",type:"find_temple"},{text:"Collect 5 apples",type:"collect",item:"apple",count:5},{text:"Knock back 10 birds",type:"knockback",count:10},{text:"Complete the Omamori ritual",type:"ritual"}]},this.survivalStats.currentObjective=this.survivalStats.objectives[0],this.updateSurvivalHUD();const e=document.getElementById("petalCanvas");e&&(e.style.display="none");const a=document.getElementById("flameParticles");a&&(a.style.visibility="hidden"),document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",document.getElementById("clickToPlay").classList.add("active"),this.gameLoopId&&cancelAnimationFrame(this.gameLoopId),setTimeout(()=>{this.updateHotbarDisplay(),this.updateHotbar()},50),this.gameLoop()},pause(){this.isActive&&(this.isPaused=!0,document.getElementById("pauseMenu").classList.add("active"),document.getElementById("gameUI").style.display="none",document.getElementById("clickToPlay").classList.remove("active"),this.showSubmenu("menuMain"),document.pointerLockElement&&document.exitPointerLock())},resume(){this.isPaused=!1,document.getElementById("pauseMenu").classList.remove("active"),document.getElementById("gameUI").style.display="flex",document.getElementById("clickToPlay").classList.add("active")},updateFullscreenButton(){const t=document.getElementById("btnFullscreen"),i=document.fullscreenElement||document.webkitFullscreenElement;t.textContent=i?"Windowed":"Fullscreen",i?(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight):(this.canvas.width=800,this.canvas.height=450)},stop(){if(this.gameLoopId&&(cancelAnimationFrame(this.gameLoopId),this.gameLoopId=null),this.isActive=!1,this.isPaused=!1,this.pointerLocked=!1,this.particles=[],this.fluidUpdates=[],this.fluidUpdateTimer=0,this.birdPruneTimer=0,this.inWater=!1,this.inLava=!1,this.swimming=!1,this.headSubmergedWater=!1,this.headSubmergedLava=!1,this.pestBirds)for(const e of this.pestBirds)e.anger=0,e.timesShot=0,e.state="circling";this.canvas.width=800,this.canvas.height=450,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),document.getElementById("minecraftGame").classList.remove("active"),document.getElementById("pauseMenu").classList.remove("active"),document.getElementById("clickToPlay").classList.remove("active"),document.getElementById("inventoryScreen").classList.remove("active"),this.inventoryOpen=!1,this.canvas.style.filter="",document.pointerLockElement&&document.exitPointerLock(),(document.fullscreenElement||document.webkitFullscreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()),this.keys={},document.body.style.overflow="",document.documentElement.style.overflow="";const t=document.getElementById("petalCanvas");t&&(t.style.display="block");const i=document.getElementById("flameParticles");i&&(i.style.visibility="visible")}};class ht{constructor(){Ct(this,"_game");Ct(this,"_initialized");this._game=Lt,this._initialized=!1}init(i={}){var e,a;if(!document.getElementById("minecraftGame")){let s=document.body;i.container&&(s=typeof i.container=="string"?document.querySelector(i.container)||document.body:i.container),rt(s)}if(this._game.init(),this._initialized=!0,i.trigger){const s=typeof i.trigger=="string"?document.querySelector(i.trigger):i.trigger;s&&(s.addEventListener("click",()=>this.start()),s.style.cursor="pointer")}return(e=document.getElementById("closeMinecraft"))==null||e.addEventListener("click",()=>this.stop()),(a=document.getElementById("clickToPlay"))==null||a.addEventListener("click",()=>{this._game.isActive&&!this._game.isPaused&&this._game.canvas&&this._game.canvas.requestPointerLock()}),window.addEventListener("beforeunload",()=>{this._game.isActive&&this.stop()}),this}start(){return this._initialized||this.init(),this._game.start(),this}stop(){return this._game.stop(),this}pause(){return this._game.pause(),this}resume(){return this._game.resume(),this}getStats(){return{...this._game.stats}}get settings(){return this._game.settings}set settings(i){Object.assign(this._game.settings,i)}get isActive(){return this._game.isActive}get isPaused(){return this._game.isPaused}get engine(){return this._game}}if(typeof window<"u"){window.SakuraCraft=ht,window.SakuraCraftGame=ht;const t=document.currentScript;if(t!=null&&t.hasAttribute("data-auto-init")){const i=t.getAttribute("data-trigger");document.addEventListener("DOMContentLoaded",()=>{const e=new ht;e.init({trigger:i??void 0}),window.sakuraCraft=e})}}_.SakuraCraftGame=ht,_.default=ht,_.minecraftGame=Lt,Object.defineProperties(_,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=sakuracraft.umd.js.map
